"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Modules = exports.Module = undefined;

var _immutable = require("immutable");

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _tokenExpander = require("./token-expander.js");

var _tokenExpander2 = _interopRequireDefault(_tokenExpander);

var _termExpander = require("./term-expander.js");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _symbol = require("./symbol");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _loadSyntax = require("./load-syntax");

var _compiler = require("./compiler");

var _compiler2 = _interopRequireDefault(_compiler);

var _transforms = require("./transforms");

var _scope = require("./scope");

var _errors = require("./errors");

var _hygieneUtils = require("./hygiene-utils");

var _syntax = require("./syntax");

var _utilsDirname = require("utils-dirname");

var _utilsDirname2 = _interopRequireDefault(_utilsDirname);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Module_432 {
  constructor(moduleSpecifier_437, isNative_438, importEntries_439, exportEntries_440, pragmas_441, body_442) {
    this.moduleSpecifier = moduleSpecifier_437;
    this.isNative = isNative_438;
    this.importEntries = importEntries_439;
    this.exportEntries = exportEntries_440;
    this.pragmas = pragmas_441;
    this.body = body_442;
  }
}
const findBindingIdentifierName_433 = term_443 => {
  (0, _errors.assert)(term_443.name, `not implemented yet for type ${ term_443.type }`);
  return term_443.name;
};
const convertExport_434 = term_444 => {
  let declaration_445 = term_444.declaration;
  let bindings_446 = [];
  if ((0, _terms.isVariableDeclaration)(declaration_445)) {
    bindings_446 = declaration_445.declarators.map(decl_448 => findBindingIdentifierName_433(decl_448.binding));
  } else if ((0, _terms.isFunctionDeclaration)(declaration_445) || (0, _terms.isClassDeclaration)(declaration_445)) {
    bindings_446.push(findBindingIdentifierName_433(declaration_445.name));
  }
  let namedExports_447 = bindings_446.map(binding_449 => {
    return new _terms2.default("ExportSpecifier", { name: null, exportedName: binding_449 });
  });
  return new _terms2.default("ExportFrom", { moduleSpecifier: null, namedExports: (0, _immutable.List)(namedExports_447) });
};
const pragmaRegep_435 = /^\s*#\w*/;
class Modules_436 {
  constructor(context_450) {
    this.compiledModules = new Map();
    this.context = context_450;
    this.context.modules = this;
  }
  loadString(str_451) {
    let checkPragma_452 = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    let hasPragma_453 = pragmaRegep_435.test(str_451);
    if (checkPragma_452 && !hasPragma_453) {
      return { isNative: true, body: (0, _immutable.List)() };
    }
    return { isNative: !hasPragma_453, body: new _shiftReader2.default(str_451).read() };
  }
  load(path_454) {
    return this.loadString(this.context.moduleLoader(path_454));
  }
  compile(mod_455, path_456) {
    let stxl_457 = mod_455.body;
    let outScope_458 = (0, _scope.freshScope)("outsideEdge");
    let inScope_459 = (0, _scope.freshScope)(`insideEdge0`);
    let compiler_460 = new _compiler2.default(0, new _env2.default(), new _store2.default(), _.merge(this.context, { currentScope: [outScope_458, inScope_459], cwd: path_456 === "<<entrypoint>>" ? this.context.cwd : (0, _utilsDirname2.default)(path_456) }));
    let terms_461 = compiler_460.compile(stxl_457.map(s_466 => s_466.addScope(outScope_458, this.context.bindings, _syntax.ALL_PHASES).addScope(inScope_459, this.context.bindings, 0)));
    let importEntries_462 = [];
    let exportEntries_463 = [];
    let pragmas_464 = [];
    let filteredTerms_465 = terms_461.reduce((acc_467, t_468) => {
      return _.cond([[_terms.isImport, t_469 => {
        importEntries_462.push(t_469);
        return acc_467;
      }], [_terms.isExport, t_470 => {
        if (t_470.declaration) {
          exportEntries_463.push(convertExport_434(t_470));
          if ((0, _terms.isVariableDeclaration)(t_470.declaration)) {
            return acc_467.concat(new _terms2.default("VariableDeclarationStatement", { declaration: t_470.declaration }));
          }
          return acc_467.concat(t_470.declaration);
        }
        exportEntries_463.push(t_470);
        return acc_467;
      }], [_terms.isPragma, t_471 => {
        pragmas_464.push(t_471);
        return acc_467;
      }], [_.T, t_472 => acc_467.concat(t_472)]])(t_468);
    }, (0, _immutable.List)());
    return new Module_432(path_456, mod_455.isNative, (0, _immutable.List)(importEntries_462), (0, _immutable.List)(exportEntries_463), (0, _immutable.List)(pragmas_464), filteredTerms_465);
  }
  compileEntrypoint(source_473, filename_474) {
    let enforcePragma_475 = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

    let stxl_476 = this.loadString(source_473, false);
    if (enforcePragma_475 && stxl_476.isNative) {
      throw new Error(`Entrypoint ${ filename_474 } must begin with #lang pragma`);
    }
    return this.getAtPhase("<<entrypoint>>", 0, this.context.cwd, stxl_476);
  }
  getAtPhase(rawPath_477, phase_478, cwd_479) {
    let rawStxl_480 = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

    let path_481 = rawPath_477 === "<<entrypoint>>" ? rawPath_477 : this.context.moduleResolver(rawPath_477, cwd_479);
    let mapKey_482 = `${ path_481 }:${ phase_478 }`;
    if (!this.compiledModules.has(mapKey_482)) {
      if (phase_478 === 0) {
        let stxl = rawStxl_480 != null ? rawStxl_480 : this.load(path_481);
        this.compiledModules.set(mapKey_482, this.compile(stxl, path_481));
      } else {
        let rawMod = this.getAtPhase(rawPath_477, 0, cwd_479, rawStxl_480);
        let scope = (0, _scope.freshScope)(`insideEdge${ phase_478 }`);
        this.compiledModules.set(mapKey_482, new Module_432(rawMod.moduleSpecifier, false, rawMod.importEntries.map(term_483 => term_483.addScope(scope, this.context.bindings, phase_478)), rawMod.exportEntries.map(term_484 => term_484.addScope(scope, this.context.bindings, phase_478)), rawMod.pragmas, rawMod.body.map(term_485 => term_485.addScope(scope, this.context.bindings, phase_478))));
      }
    }
    return this.compiledModules.get(mapKey_482);
  }
  has(rawPath_486) {
    let phase_487 = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

    let path_488 = rawPath_486 === "<<entrypoint>>" ? rawPath_486 : this.context.moduleResolver(rawPath_486, this.context.cwd);
    let key_489 = `${ path_488 }:${ phase_487 }`;
    return this.compiledModules.has(key_489) && !this.compiledModules.get(key_489).isNative;
  }
  registerSyntaxDeclaration(term_490, phase_491, store_492) {
    term_490.declarators.forEach(decl_493 => {
      let val_494 = (0, _loadSyntax.evalCompiletimeValue)(decl_493.init.gen(), _.merge(this.context, { phase: phase_491 + 1, store: store_492 }));
      (0, _hygieneUtils.collectBindings)(decl_493.binding).forEach(stx_495 => {
        if (phase_491 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_495.val());
          this.context.bindings.add(stx_495, { binding: newBinding, phase: phase_491, skipDup: false });
        }
        let resolvedName_496 = stx_495.resolve(phase_491);
        store_492.set(resolvedName_496, new _transforms.CompiletimeTransform(val_494));
      });
    });
  }
  registerVariableDeclaration(term_497, phase_498, store_499) {
    term_497.declarators.forEach(decl_500 => {
      (0, _hygieneUtils.collectBindings)(decl_500.binding).forEach(stx_501 => {
        if (phase_498 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_501.val());
          this.context.bindings.add(stx_501, { binding: newBinding, phase: phase_498, skipDup: term_497.kind === "var" });
        }
        let resolvedName_502 = stx_501.resolve(phase_498);
        store_499.set(resolvedName_502, new _transforms.VarBindingTransform(stx_501));
      });
    });
  }
  registerFunctionOrClass(term_503, phase_504, store_505) {
    (0, _hygieneUtils.collectBindings)(term_503.name).forEach(stx_506 => {
      if (phase_504 !== 0) {
        let newBinding = (0, _symbol.gensym)(stx_506.val());
        this.context.bindings.add(stx_506, { binding: newBinding, phase: phase_504, skipDup: false });
      }
      let resolvedName_507 = stx_506.resolve(phase_504);
      store_505.set(resolvedName_507, new _transforms.VarBindingTransform(stx_506));
    });
  }
  visit(mod_508, phase_509, store_510) {
    mod_508.body.forEach(term_511 => {
      if ((0, _terms.isSyntaxDeclarationStatement)(term_511)) {
        this.registerSyntaxDeclaration(term_511.declaration, phase_509, store_510);
      }
    });
    return store_510;
  }
  invoke(mod_512, phase_513, store_514) {
    let body_515 = mod_512.body.filter(_.complement(_terms.isCompiletimeStatement)).map(term_517 => {
      term_517 = term_517.gen();
      if ((0, _terms.isVariableDeclarationStatement)(term_517)) {
        this.registerVariableDeclaration(term_517.declaration, phase_513, store_514);
      } else if ((0, _terms.isFunctionDeclaration)(term_517)) {
        this.registerFunctionOrClass(term_517, phase_513, store_514);
      }
      return term_517;
    });
    let exportsObj_516 = (0, _loadSyntax.evalRuntimeValues)(body_515, _.merge(this.context, { store: store_514, phase: phase_513 }));
    return store_514;
  }
}
exports.Module = Module_432;
exports.Modules = Modules_436;
//# sourceMappingURL=data:application/json;base64,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d0IsT0FBeEIsQ0FBaEM7QUFDRCxLQVBEO0FBUUQ7QUFDRCxRQUFNLE9BQU4sRUFBZSxTQUFmLEVBQTBCLFNBQTFCLEVBQXFDO0FBQ25DLFlBQVEsSUFBUixDQUFhLE9BQWIsQ0FBcUIsWUFBWTtBQUMvQixVQUFJLHlDQUE2QixRQUE3QixDQUFKLEVBQTRDO0FBQzFDLGFBQUsseUJBQUwsQ0FBK0IsU0FBUyxXQUF4QyxFQUFxRCxTQUFyRCxFQUFnRSxTQUFoRTtBQUNEO0FBQ0YsS0FKRDtBQUtBLFdBQU8sU0FBUDtBQUNEO0FBQ0QsU0FBTyxPQUFQLEVBQWdCLFNBQWhCLEVBQTJCLFNBQTNCLEVBQXNDO0FBQ3BDLFFBQUksV0FBVyxRQUFRLElBQVIsQ0FBYSxNQUFiLENBQW9CLEVBQUUsVUFBRiwrQkFBcEIsRUFBMEQsR0FBMUQsQ0FBOEQsWUFBWTtBQUN2RixpQkFBVyxTQUFTLEdBQVQsRUFBWDtBQUNBLFVBQUksMkNBQStCLFFBQS9CLENBQUosRUFBOEM7QUFDNUMsYUFBSywyQkFBTCxDQUFpQyxTQUFTLFdBQTFDLEVBQXVELFNBQXZELEVBQWtFLFNBQWxFO0FBQ0QsT0FGRCxNQUVPLElBQUksa0NBQXNCLFFBQXRCLENBQUosRUFBcUM7QUFDMUMsYUFBSyx1QkFBTCxDQUE2QixRQUE3QixFQUF1QyxTQUF2QyxFQUFrRCxTQUFsRDtBQUNEO0FBQ0QsYUFBTyxRQUFQO0FBQ0QsS0FSYyxDQUFmO0FBU0EsUUFBSSxpQkFBaUIsbUNBQWtCLFFBQWxCLEVBQTRCLEVBQUUsS0FBRixDQUFRLEtBQUssT0FBYixFQUFzQixFQUFDLE9BQU8sU0FBUixFQUFtQixPQUFPLFNBQTFCLEVBQXRCLENBQTVCLENBQXJCO0FBQ0EsV0FBTyxTQUFQO0FBQ0Q7QUFoSWU7UUFrSUksTSxHQUFkLFU7UUFDZSxPLEdBQWYsVyIsImZpbGUiOiJtb2R1bGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgRW52IGZyb20gXCIuL2VudlwiO1xuaW1wb3J0IFN0b3JlIGZyb20gXCIuL3N0b3JlXCI7XG5pbXBvcnQgUmVhZGVyIGZyb20gXCIuL3NoaWZ0LXJlYWRlclwiO1xuaW1wb3J0IFRva2VuRXhwYW5kZXIgZnJvbSBcIi4vdG9rZW4tZXhwYW5kZXIuanNcIjtcbmltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlci5qc1wiO1xuaW1wb3J0IEJpbmRpbmdNYXAgZnJvbSBcIi4vYmluZGluZy1tYXAuanNcIjtcbmltcG9ydCB7Z2Vuc3ltfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCBUZXJtLCB7aXNFT0YsIGlzQmluZGluZ0lkZW50aWZpZXIsIGlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgaXNGdW5jdGlvbkV4cHJlc3Npb24sIGlzRnVuY3Rpb25UZXJtLCBpc0Z1bmN0aW9uV2l0aE5hbWUsIGlzU3ludGF4RGVjbGFyYXRpb24sIGlzU3ludGF4cmVjRGVjbGFyYXRpb24sIGlzVmFyaWFibGVEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50LCBpc0ltcG9ydCwgaXNFeHBvcnQsIGlzRXhwb3J0RnJvbSwgaXNFeHBvcnRBbGxGcm9tLCBpc0V4cG9ydERlZmF1bHQsIGlzRXhwb3J0U3ludGF4LCBpc1N5bnRheERlY2xhcmF0aW9uU3RhdGVtZW50LCBpc1ByYWdtYSwgaXNDb21waWxldGltZURlY2xhcmF0aW9uLCBpc0NvbXBpbGV0aW1lU3RhdGVtZW50LCBpc0NsYXNzRGVjbGFyYXRpb259IGZyb20gXCIuL3Rlcm1zXCI7XG5pbXBvcnQge2V2YWxDb21waWxldGltZVZhbHVlLCBldmFsUnVudGltZVZhbHVlc30gZnJvbSBcIi4vbG9hZC1zeW50YXhcIjtcbmltcG9ydCBDb21waWxlciBmcm9tIFwiLi9jb21waWxlclwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IHtTY29wZSwgZnJlc2hTY29wZX0gZnJvbSBcIi4vc2NvcGVcIjtcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiLi9lcnJvcnNcIjtcbmltcG9ydCB7Y29sbGVjdEJpbmRpbmdzfSBmcm9tIFwiLi9oeWdpZW5lLXV0aWxzXCI7XG5pbXBvcnQge0FMTF9QSEFTRVN9IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGRpcm5hbWUgZnJvbSBcInV0aWxzLWRpcm5hbWVcIjtcbmltcG9ydCAgKiBhcyBfIGZyb20gXCJyYW1kYVwiO1xuY2xhc3MgTW9kdWxlXzQzMiB7XG4gIGNvbnN0cnVjdG9yKG1vZHVsZVNwZWNpZmllcl80MzcsIGlzTmF0aXZlXzQzOCwgaW1wb3J0RW50cmllc180MzksIGV4cG9ydEVudHJpZXNfNDQwLCBwcmFnbWFzXzQ0MSwgYm9keV80NDIpIHtcbiAgICB0aGlzLm1vZHVsZVNwZWNpZmllciA9IG1vZHVsZVNwZWNpZmllcl80Mzc7XG4gICAgdGhpcy5pc05hdGl2ZSA9IGlzTmF0aXZlXzQzODtcbiAgICB0aGlzLmltcG9ydEVudHJpZXMgPSBpbXBvcnRFbnRyaWVzXzQzOTtcbiAgICB0aGlzLmV4cG9ydEVudHJpZXMgPSBleHBvcnRFbnRyaWVzXzQ0MDtcbiAgICB0aGlzLnByYWdtYXMgPSBwcmFnbWFzXzQ0MTtcbiAgICB0aGlzLmJvZHkgPSBib2R5XzQ0MjtcbiAgfVxufVxuY29uc3QgZmluZEJpbmRpbmdJZGVudGlmaWVyTmFtZV80MzMgPSB0ZXJtXzQ0MyA9PiB7XG4gIGFzc2VydCh0ZXJtXzQ0My5uYW1lLCBgbm90IGltcGxlbWVudGVkIHlldCBmb3IgdHlwZSAke3Rlcm1fNDQzLnR5cGV9YCk7XG4gIHJldHVybiB0ZXJtXzQ0My5uYW1lO1xufTtcbmNvbnN0IGNvbnZlcnRFeHBvcnRfNDM0ID0gdGVybV80NDQgPT4ge1xuICBsZXQgZGVjbGFyYXRpb25fNDQ1ID0gdGVybV80NDQuZGVjbGFyYXRpb247XG4gIGxldCBiaW5kaW5nc180NDYgPSBbXTtcbiAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbihkZWNsYXJhdGlvbl80NDUpKSB7XG4gICAgYmluZGluZ3NfNDQ2ID0gZGVjbGFyYXRpb25fNDQ1LmRlY2xhcmF0b3JzLm1hcChkZWNsXzQ0OCA9PiBmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQzMyhkZWNsXzQ0OC5iaW5kaW5nKSk7XG4gIH0gZWxzZSBpZiAoaXNGdW5jdGlvbkRlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ0NSkgfHwgaXNDbGFzc0RlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ0NSkpIHtcbiAgICBiaW5kaW5nc180NDYucHVzaChmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQzMyhkZWNsYXJhdGlvbl80NDUubmFtZSkpO1xuICB9XG4gIGxldCBuYW1lZEV4cG9ydHNfNDQ3ID0gYmluZGluZ3NfNDQ2Lm1hcChiaW5kaW5nXzQ0OSA9PiB7XG4gICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwb3J0U3BlY2lmaWVyXCIsIHtuYW1lOiBudWxsLCBleHBvcnRlZE5hbWU6IGJpbmRpbmdfNDQ5fSk7XG4gIH0pO1xuICByZXR1cm4gbmV3IFRlcm0oXCJFeHBvcnRGcm9tXCIsIHttb2R1bGVTcGVjaWZpZXI6IG51bGwsIG5hbWVkRXhwb3J0czogTGlzdChuYW1lZEV4cG9ydHNfNDQ3KX0pO1xufTtcbmNvbnN0IHByYWdtYVJlZ2VwXzQzNSA9IC9eXFxzKiNcXHcqLztcbmNsYXNzIE1vZHVsZXNfNDM2IHtcbiAgY29uc3RydWN0b3IoY29udGV4dF80NTApIHtcbiAgICB0aGlzLmNvbXBpbGVkTW9kdWxlcyA9IG5ldyBNYXA7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dF80NTA7XG4gICAgdGhpcy5jb250ZXh0Lm1vZHVsZXMgPSB0aGlzO1xuICB9XG4gIGxvYWRTdHJpbmcoc3RyXzQ1MSwgY2hlY2tQcmFnbWFfNDUyID0gdHJ1ZSkge1xuICAgIGxldCBoYXNQcmFnbWFfNDUzID0gcHJhZ21hUmVnZXBfNDM1LnRlc3Qoc3RyXzQ1MSk7XG4gICAgaWYgKGNoZWNrUHJhZ21hXzQ1MiAmJiAhaGFzUHJhZ21hXzQ1Mykge1xuICAgICAgcmV0dXJuIHtpc05hdGl2ZTogdHJ1ZSwgYm9keTogTGlzdCgpfTtcbiAgICB9XG4gICAgcmV0dXJuIHtpc05hdGl2ZTogIWhhc1ByYWdtYV80NTMsIGJvZHk6IG5ldyBSZWFkZXIoc3RyXzQ1MSkucmVhZCgpfTtcbiAgfVxuICBsb2FkKHBhdGhfNDU0KSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZFN0cmluZyh0aGlzLmNvbnRleHQubW9kdWxlTG9hZGVyKHBhdGhfNDU0KSk7XG4gIH1cbiAgY29tcGlsZShtb2RfNDU1LCBwYXRoXzQ1Nikge1xuICAgIGxldCBzdHhsXzQ1NyA9IG1vZF80NTUuYm9keTtcbiAgICBsZXQgb3V0U2NvcGVfNDU4ID0gZnJlc2hTY29wZShcIm91dHNpZGVFZGdlXCIpO1xuICAgIGxldCBpblNjb3BlXzQ1OSA9IGZyZXNoU2NvcGUoYGluc2lkZUVkZ2UwYCk7XG4gICAgbGV0IGNvbXBpbGVyXzQ2MCA9IG5ldyBDb21waWxlcigwLCBuZXcgRW52LCBuZXcgU3RvcmUsIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7Y3VycmVudFNjb3BlOiBbb3V0U2NvcGVfNDU4LCBpblNjb3BlXzQ1OV0sIGN3ZDogcGF0aF80NTYgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHRoaXMuY29udGV4dC5jd2QgOiBkaXJuYW1lKHBhdGhfNDU2KX0pKTtcbiAgICBsZXQgdGVybXNfNDYxID0gY29tcGlsZXJfNDYwLmNvbXBpbGUoc3R4bF80NTcubWFwKHNfNDY2ID0+IHNfNDY2LmFkZFNjb3BlKG91dFNjb3BlXzQ1OCwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCBBTExfUEhBU0VTKS5hZGRTY29wZShpblNjb3BlXzQ1OSwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCAwKSkpO1xuICAgIGxldCBpbXBvcnRFbnRyaWVzXzQ2MiA9IFtdO1xuICAgIGxldCBleHBvcnRFbnRyaWVzXzQ2MyA9IFtdO1xuICAgIGxldCBwcmFnbWFzXzQ2NCA9IFtdO1xuICAgIGxldCBmaWx0ZXJlZFRlcm1zXzQ2NSA9IHRlcm1zXzQ2MS5yZWR1Y2UoKGFjY180NjcsIHRfNDY4KSA9PiB7XG4gICAgICByZXR1cm4gXy5jb25kKFtbaXNJbXBvcnQsIHRfNDY5ID0+IHtcbiAgICAgICAgaW1wb3J0RW50cmllc180NjIucHVzaCh0XzQ2OSk7XG4gICAgICAgIHJldHVybiBhY2NfNDY3O1xuICAgICAgfV0sIFtpc0V4cG9ydCwgdF80NzAgPT4ge1xuICAgICAgICBpZiAodF80NzAuZGVjbGFyYXRpb24pIHtcbiAgICAgICAgICBleHBvcnRFbnRyaWVzXzQ2My5wdXNoKGNvbnZlcnRFeHBvcnRfNDM0KHRfNDcwKSk7XG4gICAgICAgICAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbih0XzQ3MC5kZWNsYXJhdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBhY2NfNDY3LmNvbmNhdChuZXcgVGVybShcIlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnRcIiwge2RlY2xhcmF0aW9uOiB0XzQ3MC5kZWNsYXJhdGlvbn0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFjY180NjcuY29uY2F0KHRfNDcwLmRlY2xhcmF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBleHBvcnRFbnRyaWVzXzQ2My5wdXNoKHRfNDcwKTtcbiAgICAgICAgcmV0dXJuIGFjY180Njc7XG4gICAgICB9XSwgW2lzUHJhZ21hLCB0XzQ3MSA9PiB7XG4gICAgICAgIHByYWdtYXNfNDY0LnB1c2godF80NzEpO1xuICAgICAgICByZXR1cm4gYWNjXzQ2NztcbiAgICAgIH1dLCBbXy5ULCB0XzQ3MiA9PiBhY2NfNDY3LmNvbmNhdCh0XzQ3MildXSkodF80NjgpO1xuICAgIH0sIExpc3QoKSk7XG4gICAgcmV0dXJuIG5ldyBNb2R1bGVfNDMyKHBhdGhfNDU2LCBtb2RfNDU1LmlzTmF0aXZlLCBMaXN0KGltcG9ydEVudHJpZXNfNDYyKSwgTGlzdChleHBvcnRFbnRyaWVzXzQ2MyksIExpc3QocHJhZ21hc180NjQpLCBmaWx0ZXJlZFRlcm1zXzQ2NSk7XG4gIH1cbiAgY29tcGlsZUVudHJ5cG9pbnQoc291cmNlXzQ3MywgZmlsZW5hbWVfNDc0LCBlbmZvcmNlUHJhZ21hXzQ3NSA9IGZhbHNlKSB7XG4gICAgbGV0IHN0eGxfNDc2ID0gdGhpcy5sb2FkU3RyaW5nKHNvdXJjZV80NzMsIGZhbHNlKTtcbiAgICBpZiAoZW5mb3JjZVByYWdtYV80NzUgJiYgc3R4bF80NzYuaXNOYXRpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRW50cnlwb2ludCAke2ZpbGVuYW1lXzQ3NH0gbXVzdCBiZWdpbiB3aXRoICNsYW5nIHByYWdtYWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBdFBoYXNlKFwiPDxlbnRyeXBvaW50Pj5cIiwgMCwgdGhpcy5jb250ZXh0LmN3ZCwgc3R4bF80NzYpO1xuICB9XG4gIGdldEF0UGhhc2UocmF3UGF0aF80NzcsIHBoYXNlXzQ3OCwgY3dkXzQ3OSwgcmF3U3R4bF80ODAgPSBudWxsKSB7XG4gICAgbGV0IHBhdGhfNDgxID0gcmF3UGF0aF80NzcgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHJhd1BhdGhfNDc3IDogdGhpcy5jb250ZXh0Lm1vZHVsZVJlc29sdmVyKHJhd1BhdGhfNDc3LCBjd2RfNDc5KTtcbiAgICBsZXQgbWFwS2V5XzQ4MiA9IGAke3BhdGhfNDgxfToke3BoYXNlXzQ3OH1gO1xuICAgIGlmICghdGhpcy5jb21waWxlZE1vZHVsZXMuaGFzKG1hcEtleV80ODIpKSB7XG4gICAgICBpZiAocGhhc2VfNDc4ID09PSAwKSB7XG4gICAgICAgIGxldCBzdHhsID0gcmF3U3R4bF80ODAgIT0gbnVsbCA/IHJhd1N0eGxfNDgwIDogdGhpcy5sb2FkKHBhdGhfNDgxKTtcbiAgICAgICAgdGhpcy5jb21waWxlZE1vZHVsZXMuc2V0KG1hcEtleV80ODIsIHRoaXMuY29tcGlsZShzdHhsLCBwYXRoXzQ4MSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHJhd01vZCA9IHRoaXMuZ2V0QXRQaGFzZShyYXdQYXRoXzQ3NywgMCwgY3dkXzQ3OSwgcmF3U3R4bF80ODApO1xuICAgICAgICBsZXQgc2NvcGUgPSBmcmVzaFNjb3BlKGBpbnNpZGVFZGdlJHtwaGFzZV80Nzh9YCk7XG4gICAgICAgIHRoaXMuY29tcGlsZWRNb2R1bGVzLnNldChtYXBLZXlfNDgyLCBuZXcgTW9kdWxlXzQzMihyYXdNb2QubW9kdWxlU3BlY2lmaWVyLCBmYWxzZSwgcmF3TW9kLmltcG9ydEVudHJpZXMubWFwKHRlcm1fNDgzID0+IHRlcm1fNDgzLmFkZFNjb3BlKHNjb3BlLCB0aGlzLmNvbnRleHQuYmluZGluZ3MsIHBoYXNlXzQ3OCkpLCByYXdNb2QuZXhwb3J0RW50cmllcy5tYXAodGVybV80ODQgPT4gdGVybV80ODQuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNDc4KSksIHJhd01vZC5wcmFnbWFzLCByYXdNb2QuYm9keS5tYXAodGVybV80ODUgPT4gdGVybV80ODUuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNDc4KSkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmdldChtYXBLZXlfNDgyKTtcbiAgfVxuICBoYXMocmF3UGF0aF80ODYsIHBoYXNlXzQ4NyA9IDApIHtcbiAgICBsZXQgcGF0aF80ODggPSByYXdQYXRoXzQ4NiA9PT0gXCI8PGVudHJ5cG9pbnQ+PlwiID8gcmF3UGF0aF80ODYgOiB0aGlzLmNvbnRleHQubW9kdWxlUmVzb2x2ZXIocmF3UGF0aF80ODYsIHRoaXMuY29udGV4dC5jd2QpO1xuICAgIGxldCBrZXlfNDg5ID0gYCR7cGF0aF80ODh9OiR7cGhhc2VfNDg3fWA7XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmhhcyhrZXlfNDg5KSAmJiAhdGhpcy5jb21waWxlZE1vZHVsZXMuZ2V0KGtleV80ODkpLmlzTmF0aXZlO1xuICB9XG4gIHJlZ2lzdGVyU3ludGF4RGVjbGFyYXRpb24odGVybV80OTAsIHBoYXNlXzQ5MSwgc3RvcmVfNDkyKSB7XG4gICAgdGVybV80OTAuZGVjbGFyYXRvcnMuZm9yRWFjaChkZWNsXzQ5MyA9PiB7XG4gICAgICBsZXQgdmFsXzQ5NCA9IGV2YWxDb21waWxldGltZVZhbHVlKGRlY2xfNDkzLmluaXQuZ2VuKCksIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7cGhhc2U6IHBoYXNlXzQ5MSArIDEsIHN0b3JlOiBzdG9yZV80OTJ9KSk7XG4gICAgICBjb2xsZWN0QmluZGluZ3MoZGVjbF80OTMuYmluZGluZykuZm9yRWFjaChzdHhfNDk1ID0+IHtcbiAgICAgICAgaWYgKHBoYXNlXzQ5MSAhPT0gMCkge1xuICAgICAgICAgIGxldCBuZXdCaW5kaW5nID0gZ2Vuc3ltKHN0eF80OTUudmFsKCkpO1xuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzQ5NSwge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV80OTEsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV80OTYgPSBzdHhfNDk1LnJlc29sdmUocGhhc2VfNDkxKTtcbiAgICAgICAgc3RvcmVfNDkyLnNldChyZXNvbHZlZE5hbWVfNDk2LCBuZXcgQ29tcGlsZXRpbWVUcmFuc2Zvcm0odmFsXzQ5NCkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcmVnaXN0ZXJWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fNDk3LCBwaGFzZV80OTgsIHN0b3JlXzQ5OSkge1xuICAgIHRlcm1fNDk3LmRlY2xhcmF0b3JzLmZvckVhY2goZGVjbF81MDAgPT4ge1xuICAgICAgY29sbGVjdEJpbmRpbmdzKGRlY2xfNTAwLmJpbmRpbmcpLmZvckVhY2goc3R4XzUwMSA9PiB7XG4gICAgICAgIGlmIChwaGFzZV80OTggIT09IDApIHtcbiAgICAgICAgICBsZXQgbmV3QmluZGluZyA9IGdlbnN5bShzdHhfNTAxLnZhbCgpKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQuYmluZGluZ3MuYWRkKHN0eF81MDEsIHtiaW5kaW5nOiBuZXdCaW5kaW5nLCBwaGFzZTogcGhhc2VfNDk4LCBza2lwRHVwOiB0ZXJtXzQ5Ny5raW5kID09PSBcInZhclwifSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV81MDIgPSBzdHhfNTAxLnJlc29sdmUocGhhc2VfNDk4KTtcbiAgICAgICAgc3RvcmVfNDk5LnNldChyZXNvbHZlZE5hbWVfNTAyLCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTAxKSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICByZWdpc3RlckZ1bmN0aW9uT3JDbGFzcyh0ZXJtXzUwMywgcGhhc2VfNTA0LCBzdG9yZV81MDUpIHtcbiAgICBjb2xsZWN0QmluZGluZ3ModGVybV81MDMubmFtZSkuZm9yRWFjaChzdHhfNTA2ID0+IHtcbiAgICAgIGlmIChwaGFzZV81MDQgIT09IDApIHtcbiAgICAgICAgbGV0IG5ld0JpbmRpbmcgPSBnZW5zeW0oc3R4XzUwNi52YWwoKSk7XG4gICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzUwNiwge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV81MDQsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICB9XG4gICAgICBsZXQgcmVzb2x2ZWROYW1lXzUwNyA9IHN0eF81MDYucmVzb2x2ZShwaGFzZV81MDQpO1xuICAgICAgc3RvcmVfNTA1LnNldChyZXNvbHZlZE5hbWVfNTA3LCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTA2KSk7XG4gICAgfSk7XG4gIH1cbiAgdmlzaXQobW9kXzUwOCwgcGhhc2VfNTA5LCBzdG9yZV81MTApIHtcbiAgICBtb2RfNTA4LmJvZHkuZm9yRWFjaCh0ZXJtXzUxMSA9PiB7XG4gICAgICBpZiAoaXNTeW50YXhEZWNsYXJhdGlvblN0YXRlbWVudCh0ZXJtXzUxMSkpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN5bnRheERlY2xhcmF0aW9uKHRlcm1fNTExLmRlY2xhcmF0aW9uLCBwaGFzZV81MDksIHN0b3JlXzUxMCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN0b3JlXzUxMDtcbiAgfVxuICBpbnZva2UobW9kXzUxMiwgcGhhc2VfNTEzLCBzdG9yZV81MTQpIHtcbiAgICBsZXQgYm9keV81MTUgPSBtb2RfNTEyLmJvZHkuZmlsdGVyKF8uY29tcGxlbWVudChpc0NvbXBpbGV0aW1lU3RhdGVtZW50KSkubWFwKHRlcm1fNTE3ID0+IHtcbiAgICAgIHRlcm1fNTE3ID0gdGVybV81MTcuZ2VuKCk7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50KHRlcm1fNTE3KSkge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtXzUxNy5kZWNsYXJhdGlvbiwgcGhhc2VfNTEzLCBzdG9yZV81MTQpO1xuICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uRGVjbGFyYXRpb24odGVybV81MTcpKSB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybV81MTcsIHBoYXNlXzUxMywgc3RvcmVfNTE0KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0ZXJtXzUxNztcbiAgICB9KTtcbiAgICBsZXQgZXhwb3J0c09ial81MTYgPSBldmFsUnVudGltZVZhbHVlcyhib2R5XzUxNSwgXy5tZXJnZSh0aGlzLmNvbnRleHQsIHtzdG9yZTogc3RvcmVfNTE0LCBwaGFzZTogcGhhc2VfNTEzfSkpO1xuICAgIHJldHVybiBzdG9yZV81MTQ7XG4gIH1cbn1cbmV4cG9ydCB7TW9kdWxlXzQzMiBhcyBNb2R1bGV9O1xuZXhwb3J0IHtNb2R1bGVzXzQzNiBhcyBNb2R1bGVzfSJdfQ==