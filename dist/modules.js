"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Modules = exports.Module = undefined;

var _immutable = require("immutable");

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _tokenExpander = require("./token-expander.js");

var _tokenExpander2 = _interopRequireDefault(_tokenExpander);

var _termExpander = require("./term-expander.js");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _symbol = require("./symbol");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _loadSyntax = require("./load-syntax");

var _compiler = require("./compiler");

var _compiler2 = _interopRequireDefault(_compiler);

var _transforms = require("./transforms");

var _scope = require("./scope");

var _errors = require("./errors");

var _hygieneUtils = require("./hygiene-utils");

var _syntax = require("./syntax");

var _utilsDirname = require("utils-dirname");

var _utilsDirname2 = _interopRequireDefault(_utilsDirname);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Module_423 {
  constructor(moduleSpecifier_428, isNative_429, importEntries_430, exportEntries_431, pragmas_432, body_433) {
    this.moduleSpecifier = moduleSpecifier_428;
    this.isNative = isNative_429;
    this.importEntries = importEntries_430;
    this.exportEntries = exportEntries_431;
    this.pragmas = pragmas_432;
    this.body = body_433;
  }
}
const findBindingIdentifierName_424 = term_434 => {
  (0, _errors.assert)(term_434.name, `not implemented yet for type ${ term_434.type }`);
  return term_434.name;
};
const convertExport_425 = term_435 => {
  let declaration_436 = term_435.declaration;
  let bindings_437 = [];
  if ((0, _terms.isVariableDeclaration)(declaration_436)) {
    bindings_437 = declaration_436.declarators.map(decl_439 => findBindingIdentifierName_424(decl_439.binding));
  } else if ((0, _terms.isFunctionDeclaration)(declaration_436) || (0, _terms.isClassDeclaration)(declaration_436)) {
    bindings_437.push(findBindingIdentifierName_424(declaration_436.name));
  }
  let namedExports_438 = bindings_437.map(binding_440 => {
    return new _terms2.default("ExportSpecifier", { name: null, exportedName: binding_440 });
  });
  return new _terms2.default("ExportFrom", { moduleSpecifier: null, namedExports: (0, _immutable.List)(namedExports_438) });
};
const pragmaRegep_426 = /^\s*#\w*/;
class Modules_427 {
  constructor(context_441) {
    this.compiledModules = new Map();
    this.context = context_441;
    this.context.modules = this;
  }
  loadString(str_442) {
    let checkPragma_443 = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    let hasPragma_444 = pragmaRegep_426.test(str_442);
    if (checkPragma_443 && !hasPragma_444) {
      return { isNative: true, body: (0, _immutable.List)() };
    }
    return { isNative: !hasPragma_444, body: new _shiftReader2.default(str_442).read() };
  }
  load(path_445) {
    return this.loadString(this.context.moduleLoader(path_445));
  }
  compile(mod_446, path_447) {
    let stxl_448 = mod_446.body;
    let outScope_449 = (0, _scope.freshScope)("outsideEdge");
    let inScope_450 = (0, _scope.freshScope)(`insideEdge0`);
    let compiler_451 = new _compiler2.default(0, new _env2.default(), new _store2.default(), _.merge(this.context, { currentScope: [outScope_449, inScope_450], cwd: path_447 === "<<entrypoint>>" ? this.context.cwd : (0, _utilsDirname2.default)(path_447) }));
    let terms_452 = compiler_451.compile(stxl_448.map(s_457 => s_457.addScope(outScope_449, this.context.bindings, _syntax.ALL_PHASES).addScope(inScope_450, this.context.bindings, 0)));
    let importEntries_453 = [];
    let exportEntries_454 = [];
    let pragmas_455 = [];
    let filteredTerms_456 = terms_452.reduce((acc_458, t_459) => {
      return _.cond([[_terms.isImport, t_460 => {
        importEntries_453.push(t_460);
        return acc_458;
      }], [_terms.isExport, t_461 => {
        if (t_461.declaration) {
          exportEntries_454.push(convertExport_425(t_461));
          if ((0, _terms.isVariableDeclaration)(t_461.declaration)) {
            return acc_458.concat(new _terms2.default("VariableDeclarationStatement", { declaration: t_461.declaration }));
          }
          return acc_458.concat(t_461.declaration);
        }
        exportEntries_454.push(t_461);
        return acc_458;
      }], [_terms.isPragma, t_462 => {
        pragmas_455.push(t_462);
        return acc_458;
      }], [_.T, t_463 => acc_458.concat(t_463)]])(t_459);
    }, (0, _immutable.List)());
    return new Module_423(path_447, mod_446.isNative, (0, _immutable.List)(importEntries_453), (0, _immutable.List)(exportEntries_454), (0, _immutable.List)(pragmas_455), filteredTerms_456);
  }
  compileEntrypoint(source_464, filename_465) {
    let enforcePragma_466 = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

    let stxl_467 = this.loadString(source_464, false);
    if (enforcePragma_466 && stxl_467.isNative) {
      throw new Error(`Entrypoint ${ filename_465 } must begin with #lang pragma`);
    }
    return this.getAtPhase("<<entrypoint>>", 0, this.context.cwd, stxl_467);
  }
  getAtPhase(rawPath_468, phase_469, cwd_470) {
    let rawStxl_471 = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

    let path_472 = rawPath_468 === "<<entrypoint>>" ? rawPath_468 : this.context.moduleResolver(rawPath_468, cwd_470);
    let mapKey_473 = `${ path_472 }:${ phase_469 }`;
    if (!this.compiledModules.has(mapKey_473)) {
      if (phase_469 === 0) {
        let stxl = rawStxl_471 != null ? rawStxl_471 : this.load(path_472);
        this.compiledModules.set(mapKey_473, this.compile(stxl, path_472));
      } else {
        let rawMod = this.getAtPhase(rawPath_468, 0, cwd_470, rawStxl_471);
        let scope = (0, _scope.freshScope)(`insideEdge${ phase_469 }`);
        this.compiledModules.set(mapKey_473, new Module_423(rawMod.moduleSpecifier, false, rawMod.importEntries.map(term_474 => term_474.addScope(scope, this.context.bindings, phase_469)), rawMod.exportEntries.map(term_475 => term_475.addScope(scope, this.context.bindings, phase_469)), rawMod.pragmas, rawMod.body.map(term_476 => term_476.addScope(scope, this.context.bindings, phase_469))));
      }
    }
    return this.compiledModules.get(mapKey_473);
  }
  has(rawPath_477) {
    let phase_478 = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

    let path_479 = rawPath_477 === "<<entrypoint>>" ? rawPath_477 : this.context.moduleResolver(rawPath_477, this.context.cwd);
    let key_480 = `${ path_479 }:${ phase_478 }`;
    return this.compiledModules.has(key_480) && !this.compiledModules.get(key_480).isNative;
  }
  registerSyntaxDeclaration(term_481, phase_482, store_483) {
    term_481.declarators.forEach(decl_484 => {
      let val_485 = (0, _loadSyntax.evalCompiletimeValue)(decl_484.init.gen(), _.merge(this.context, { phase: phase_482 + 1, store: store_483 }));
      (0, _hygieneUtils.collectBindings)(decl_484.binding).forEach(stx_486 => {
        if (phase_482 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_486.val());
          this.context.bindings.add(stx_486, { binding: newBinding, phase: phase_482, skipDup: false });
        }
        let resolvedName_487 = stx_486.resolve(phase_482);
        store_483.set(resolvedName_487, new _transforms.CompiletimeTransform(val_485));
      });
    });
  }
  registerVariableDeclaration(term_488, phase_489, store_490) {
    term_488.declarators.forEach(decl_491 => {
      (0, _hygieneUtils.collectBindings)(decl_491.binding).forEach(stx_492 => {
        if (phase_489 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_492.val());
          this.context.bindings.add(stx_492, { binding: newBinding, phase: phase_489, skipDup: term_488.kind === "var" });
        }
        let resolvedName_493 = stx_492.resolve(phase_489);
        store_490.set(resolvedName_493, new _transforms.VarBindingTransform(stx_492));
      });
    });
  }
  registerFunctionOrClass(term_494, phase_495, store_496) {
    (0, _hygieneUtils.collectBindings)(term_494.name).forEach(stx_497 => {
      if (phase_495 !== 0) {
        let newBinding = (0, _symbol.gensym)(stx_497.val());
        this.context.bindings.add(stx_497, { binding: newBinding, phase: phase_495, skipDup: false });
      }
      let resolvedName_498 = stx_497.resolve(phase_495);
      store_496.set(resolvedName_498, new _transforms.VarBindingTransform(stx_497));
    });
  }
  visit(mod_499, phase_500, store_501) {
    mod_499.body.forEach(term_502 => {
      if ((0, _terms.isSyntaxDeclarationStatement)(term_502)) {
        this.registerSyntaxDeclaration(term_502.declaration, phase_500, store_501);
      }
    });
    return store_501;
  }
  invoke(mod_503, phase_504, store_505) {
    let body_506 = mod_503.body.filter(_.complement(_terms.isCompiletimeStatement)).map(term_508 => {
      term_508 = term_508.gen();
      if ((0, _terms.isVariableDeclarationStatement)(term_508)) {
        this.registerVariableDeclaration(term_508.declaration, phase_504, store_505);
      } else if ((0, _terms.isFunctionDeclaration)(term_508)) {
        this.registerFunctionOrClass(term_508, phase_504, store_505);
      }
      return term_508;
    });
    let exportsObj_507 = (0, _loadSyntax.evalRuntimeValues)(body_506, _.merge(this.context, { store: store_505, phase: phase_504 }));
    return store_505;
  }
}
exports.Module = Module_423;
exports.Modules = Modules_427;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L21vZHVsZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztJQUFhLEM7Ozs7OztBQUNiLE1BQU0sVUFBTixDQUFpQjtBQUNmLGNBQVksbUJBQVosRUFBaUMsWUFBakMsRUFBK0MsaUJBQS9DLEVBQWtFLGlCQUFsRSxFQUFxRixXQUFyRixFQUFrRyxRQUFsRyxFQUE0RztBQUMxRyxTQUFLLGVBQUwsR0FBdUIsbUJBQXZCO0FBQ0EsU0FBSyxRQUFMLEdBQWdCLFlBQWhCO0FBQ0EsU0FBSyxhQUFMLEdBQXFCLGlCQUFyQjtBQUNBLFNBQUssYUFBTCxHQUFxQixpQkFBckI7QUFDQSxTQUFLLE9BQUwsR0FBZSxXQUFmO0FBQ0EsU0FBSyxJQUFMLEdBQVksUUFBWjtBQUNEO0FBUmM7QUFVakIsTUFBTSxnQ0FBZ0MsWUFBWTtBQUNoRCxzQkFBTyxTQUFTLElBQWhCLEVBQXNCLENBQUMsNkJBQUQsR0FBZ0MsU0FBUyxJQUF6QyxFQUE4QyxBQUE5QyxDQUF0QjtBQUNBLFNBQU8sU0FBUyxJQUFoQjtBQUNELENBSEQ7QUFJQSxNQUFNLG9CQUFvQixZQUFZO0FBQ3BDLE1BQUksa0JBQWtCLFNBQVMsV0FBL0I7QUFDQSxNQUFJLGVBQWUsRUFBbkI7QUFDQSxNQUFJLGtDQUFzQixlQUF0QixDQUFKLEVBQTRDO0FBQzFDLG1CQUFlLGdCQUFnQixXQUFoQixDQUE0QixHQUE1QixDQUFnQyxZQUFZLDhCQUE4QixTQUFTLE9BQXZDLENBQTVDLENBQWY7QUFDRCxHQUZELE1BRU8sSUFBSSxrQ0FBc0IsZUFBdEIsS0FBMEMsK0JBQW1CLGVBQW5CLENBQTlDLEVBQW1GO0FBQ3hGLGlCQUFhLElBQWIsQ0FBa0IsOEJBQThCLGdCQUFnQixJQUE5QyxDQUFsQjtBQUNEO0FBQ0QsTUFBSSxtQkFBbUIsYUFBYSxHQUFiLENBQWlCLGVBQWU7QUFDckQsV0FBTyxvQkFBUyxpQkFBVCxFQUE0QixFQUFDLE1BQU0sSUFBUCxFQUFhLGNBQWMsV0FBM0IsRUFBNUIsQ0FBUDtBQUNELEdBRnNCLENBQXZCO0FBR0EsU0FBTyxvQkFBUyxZQUFULEVBQXVCLEVBQUMsaUJBQWlCLElBQWxCLEVBQXdCLGNBQWMscUJBQUssZ0JBQUwsQ0FBdEMsRUFBdkIsQ0FBUDtBQUNELENBWkQ7QUFhQSxNQUFNLGtCQUFrQixVQUF4QjtBQUNBLE1BQU0sV0FBTixDQUFrQjtBQUNoQixjQUFZLFdBQVosRUFBeUI7QUFDdkIsU0FBSyxlQUFMLEdBQXVCLElBQUksR0FBSixFQUF2QjtBQUNBLFNBQUssT0FBTCxHQUFlLFdBQWY7QUFDQSxTQUFLLE9BQUwsQ0FBYSxPQUFiLEdBQXVCLElBQXZCO0FBQ0Q7QUFDRCxhQUFXLE9BQVgsRUFBNEM7QUFBQSxRQUF4QixlQUF3Qix5REFBTixJQUFNOztBQUMxQyxRQUFJLGdCQUFnQixnQkFBZ0IsSUFBaEIsQ0FBcUIsT0FBckIsQ0FBcEI7QUFDQSxRQUFJLG1CQUFtQixDQUFDLGFBQXhCLEVBQXVDO0FBQ3JDLGFBQU8sRUFBQyxVQUFVLElBQVgsRUFBaUIsTUFBTSxzQkFBdkIsRUFBUDtBQUNEO0FBQ0QsV0FBTyxFQUFDLFVBQVUsQ0FBQyxhQUFaLEVBQTJCLE1BQU0sMEJBQVcsT0FBWCxFQUFvQixJQUFwQixFQUFqQyxFQUFQO0FBQ0Q7QUFDRCxPQUFLLFFBQUwsRUFBZTtBQUNiLFdBQU8sS0FBSyxVQUFMLENBQWdCLEtBQUssT0FBTCxDQUFhLFlBQWIsQ0FBMEIsUUFBMUIsQ0FBaEIsQ0FBUDtBQUNEO0FBQ0QsVUFBUSxPQUFSLEVBQWlCLFFBQWpCLEVBQTJCO0FBQ3pCLFFBQUksV0FBVyxRQUFRLElBQXZCO0FBQ0EsUUFBSSxlQUFlLHVCQUFXLGFBQVgsQ0FBbkI7QUFDQSxRQUFJLGNBQWMsdUJBQVcsQ0FBQyxXQUFELENBQVgsQ0FBbEI7QUFDQSxRQUFJLGVBQWUsdUJBQWEsQ0FBYixFQUFnQixtQkFBaEIsRUFBeUIscUJBQXpCLEVBQW9DLEVBQUUsS0FBRixDQUFRLEtBQUssT0FBYixFQUFzQixFQUFDLGNBQWMsQ0FBQyxZQUFELEVBQWUsV0FBZixDQUFmLEVBQTRDLEtBQUssYUFBYSxnQkFBYixHQUFnQyxLQUFLLE9BQUwsQ0FBYSxHQUE3QyxHQUFtRCw0QkFBUSxRQUFSLENBQXBHLEVBQXRCLENBQXBDLENBQW5CO0FBQ0EsUUFBSSxZQUFZLGFBQWEsT0FBYixDQUFxQixTQUFTLEdBQVQsQ0FBYSxTQUFTLE1BQU0sUUFBTixDQUFlLFlBQWYsRUFBNkIsS0FBSyxPQUFMLENBQWEsUUFBMUMsc0JBQWdFLFFBQWhFLENBQXlFLFdBQXpFLEVBQXNGLEtBQUssT0FBTCxDQUFhLFFBQW5HLEVBQTZHLENBQTdHLENBQXRCLENBQXJCLENBQWhCO0FBQ0EsUUFBSSxvQkFBb0IsRUFBeEI7QUFDQSxRQUFJLG9CQUFvQixFQUF4QjtBQUNBLFFBQUksY0FBYyxFQUFsQjtBQUNBLFFBQUksb0JBQW9CLFVBQVUsTUFBVixDQUFpQixDQUFDLE9BQUQsRUFBVSxLQUFWLEtBQW9CO0FBQzNELGFBQU8sRUFBRSxJQUFGLENBQU8sQ0FBQyxrQkFBVyxTQUFTO0FBQ2pDLDBCQUFrQixJQUFsQixDQUF1QixLQUF2QjtBQUNBLGVBQU8sT0FBUDtBQUNELE9BSGMsQ0FBRCxFQUdWLGtCQUFXLFNBQVM7QUFDdEIsWUFBSSxNQUFNLFdBQVYsRUFBdUI7QUFDckIsNEJBQWtCLElBQWxCLENBQXVCLGtCQUFrQixLQUFsQixDQUF2QjtBQUNBLGNBQUksa0NBQXNCLE1BQU0sV0FBNUIsQ0FBSixFQUE4QztBQUM1QyxtQkFBTyxRQUFRLE1BQVIsQ0FBZSxvQkFBUyw4QkFBVCxFQUF5QyxFQUFDLGFBQWEsTUFBTSxXQUFwQixFQUF6QyxDQUFmLENBQVA7QUFDRDtBQUNELGlCQUFPLFFBQVEsTUFBUixDQUFlLE1BQU0sV0FBckIsQ0FBUDtBQUNEO0FBQ0QsMEJBQWtCLElBQWxCLENBQXVCLEtBQXZCO0FBQ0EsZUFBTyxPQUFQO0FBQ0QsT0FWRyxDQUhVLEVBYVYsa0JBQVcsU0FBUztBQUN0QixvQkFBWSxJQUFaLENBQWlCLEtBQWpCO0FBQ0EsZUFBTyxPQUFQO0FBQ0QsT0FIRyxDQWJVLEVBZ0JWLENBQUMsRUFBRSxDQUFILEVBQU0sU0FBUyxRQUFRLE1BQVIsQ0FBZSxLQUFmLENBQWYsQ0FoQlUsQ0FBUCxFQWdCcUMsS0FoQnJDLENBQVA7QUFpQkQsS0FsQnVCLEVBa0JyQixzQkFsQnFCLENBQXhCO0FBbUJBLFdBQU8sSUFBSSxVQUFKLENBQWUsUUFBZixFQUF5QixRQUFRLFFBQWpDLEVBQTJDLHFCQUFLLGlCQUFMLENBQTNDLEVBQW9FLHFCQUFLLGlCQUFMLENBQXBFLEVBQTZGLHFCQUFLLFdBQUwsQ0FBN0YsRUFBZ0gsaUJBQWhILENBQVA7QUFDRDtBQUNELG9CQUFrQixVQUFsQixFQUE4QixZQUE5QixFQUF1RTtBQUFBLFFBQTNCLGlCQUEyQix5REFBUCxLQUFPOztBQUNyRSxRQUFJLFdBQVcsS0FBSyxVQUFMLENBQWdCLFVBQWhCLEVBQTRCLEtBQTVCLENBQWY7QUFDQSxRQUFJLHFCQUFxQixTQUFTLFFBQWxDLEVBQTRDO0FBQzFDLFlBQU0sSUFBSSxLQUFKLENBQVUsQ0FBQyxXQUFELEdBQWMsWUFBZCxFQUEyQiw2QkFBM0IsQ0FBVixDQUFOO0FBQ0Q7QUFDRCxXQUFPLEtBQUssVUFBTCxDQUFnQixnQkFBaEIsRUFBa0MsQ0FBbEMsRUFBcUMsS0FBSyxPQUFMLENBQWEsR0FBbEQsRUFBdUQsUUFBdkQsQ0FBUDtBQUNEO0FBQ0QsYUFBVyxXQUFYLEVBQXdCLFNBQXhCLEVBQW1DLE9BQW5DLEVBQWdFO0FBQUEsUUFBcEIsV0FBb0IseURBQU4sSUFBTTs7QUFDOUQsUUFBSSxXQUFXLGdCQUFnQixnQkFBaEIsR0FBbUMsV0FBbkMsR0FBaUQsS0FBSyxPQUFMLENBQWEsY0FBYixDQUE0QixXQUE1QixFQUF5QyxPQUF6QyxDQUFoRTtBQUNBLFFBQUksYUFBYSxDQUFDLEFBQUQsR0FBRyxRQUFILEVBQVksQ0FBWixHQUFlLFNBQWYsRUFBeUIsQUFBekIsQ0FBakI7QUFDQSxRQUFJLENBQUMsS0FBSyxlQUFMLENBQXFCLEdBQXJCLENBQXlCLFVBQXpCLENBQUwsRUFBMkM7QUFDekMsVUFBSSxjQUFjLENBQWxCLEVBQXFCO0FBQ25CLFlBQUksT0FBTyxlQUFlLElBQWYsR0FBc0IsV0FBdEIsR0FBb0MsS0FBSyxJQUFMLENBQVUsUUFBVixDQUEvQztBQUNBLGFBQUssZUFBTCxDQUFxQixHQUFyQixDQUF5QixVQUF6QixFQUFxQyxLQUFLLE9BQUwsQ0FBYSxJQUFiLEVBQW1CLFFBQW5CLENBQXJDO0FBQ0QsT0FIRCxNQUdPO0FBQ0wsWUFBSSxTQUFTLEtBQUssVUFBTCxDQUFnQixXQUFoQixFQUE2QixDQUE3QixFQUFnQyxPQUFoQyxFQUF5QyxXQUF6QyxDQUFiO0FBQ0EsWUFBSSxRQUFRLHVCQUFXLENBQUMsVUFBRCxHQUFhLFNBQWIsRUFBdUIsQUFBdkIsQ0FBWCxDQUFaO0FBQ0EsYUFBSyxlQUFMLENBQXFCLEdBQXJCLENBQXlCLFVBQXpCLEVBQXFDLElBQUksVUFBSixDQUFlLE9BQU8sZUFBdEIsRUFBdUMsS0FBdkMsRUFBOEMsT0FBTyxhQUFQLENBQXFCLEdBQXJCLENBQXlCLFlBQVksU0FBUyxRQUFULENBQWtCLEtBQWxCLEVBQXlCLEtBQUssT0FBTCxDQUFhLFFBQXRDLEVBQWdELFNBQWhELENBQXJDLENBQTlDLEVBQWdKLE9BQU8sYUFBUCxDQUFxQixHQUFyQixDQUF5QixZQUFZLFNBQVMsUUFBVCxDQUFrQixLQUFsQixFQUF5QixLQUFLLE9BQUwsQ0FBYSxRQUF0QyxFQUFnRCxTQUFoRCxDQUFyQyxDQUFoSixFQUFrUCxPQUFPLE9BQXpQLEVBQWtRLE9BQU8sSUFBUCxDQUFZLEdBQVosQ0FBZ0IsWUFBWSxTQUFTLFFBQVQsQ0FBa0IsS0FBbEIsRUFBeUIsS0FBSyxPQUFMLENBQWEsUUFBdEMsRUFBZ0QsU0FBaEQsQ0FBNUIsQ0FBbFEsQ0FBckM7QUFDRDtBQUNGO0FBQ0QsV0FBTyxLQUFLLGVBQUwsQ0FBcUIsR0FBckIsQ0FBeUIsVUFBekIsQ0FBUDtBQUNEO0FBQ0QsTUFBSSxXQUFKLEVBQWdDO0FBQUEsUUFBZixTQUFlLHlEQUFILENBQUc7O0FBQzlCLFFBQUksV0FBVyxnQkFBZ0IsZ0JBQWhCLEdBQW1DLFdBQW5DLEdBQWlELEtBQUssT0FBTCxDQUFhLGNBQWIsQ0FBNEIsV0FBNUIsRUFBeUMsS0FBSyxPQUFMLENBQWEsR0FBdEQsQ0FBaEU7QUFDQSxRQUFJLFVBQVUsQ0FBQyxBQUFELEdBQUcsUUFBSCxFQUFZLENBQVosR0FBZSxTQUFmLEVBQXlCLEFBQXpCLENBQWQ7QUFDQSxXQUFPLEtBQUssZUFBTCxDQUFxQixHQUFyQixDQUF5QixPQUF6QixLQUFxQyxDQUFDLEtBQUssZUFBTCxDQUFxQixHQUFyQixDQUF5QixPQUF6QixFQUFrQyxRQUEvRTtBQUNEO0FBQ0QsNEJBQTBCLFFBQTFCLEVBQW9DLFNBQXBDLEVBQStDLFNBQS9DLEVBQTBEO0FBQ3hELGFBQVMsV0FBVCxDQUFxQixPQUFyQixDQUE2QixZQUFZO0FBQ3ZDLFVBQUksVUFBVSxzQ0FBcUIsU0FBUyxJQUFULENBQWMsR0FBZCxFQUFyQixFQUEwQyxFQUFFLEtBQUYsQ0FBUSxLQUFLLE9BQWIsRUFBc0IsRUFBQyxPQUFPLFlBQVksQ0FBcEIsRUFBdUIsT0FBTyxTQUE5QixFQUF0QixDQUExQyxDQUFkO0FBQ0EseUNBQWdCLFNBQVMsT0FBekIsRUFBa0MsT0FBbEMsQ0FBMEMsV0FBVztBQUNuRCxZQUFJLGNBQWMsQ0FBbEIsRUFBcUI7QUFDbkIsY0FBSSxhQUFhLG9CQUFPLFFBQVEsR0FBUixFQUFQLENBQWpCO0FBQ0EsZUFBSyxPQUFMLENBQWEsUUFBYixDQUFzQixHQUF0QixDQUEwQixPQUExQixFQUFtQyxFQUFDLFNBQVMsVUFBVixFQUFzQixPQUFPLFNBQTdCLEVBQXdDLFNBQVMsS0FBakQsRUFBbkM7QUFDRDtBQUNELFlBQUksbUJBQW1CLFFBQVEsT0FBUixDQUFnQixTQUFoQixDQUF2QjtBQUNBLGtCQUFVLEdBQVYsQ0FBYyxnQkFBZCxFQUFnQyxxQ0FBeUIsT0FBekIsQ0FBaEM7QUFDRCxPQVBEO0FBUUQsS0FWRDtBQVdEO0FBQ0QsOEJBQTRCLFFBQTVCLEVBQXNDLFNBQXRDLEVBQWlELFNBQWpELEVBQTREO0FBQzFELGFBQVMsV0FBVCxDQUFxQixPQUFyQixDQUE2QixZQUFZO0FBQ3ZDLHlDQUFnQixTQUFTLE9BQXpCLEVBQWtDLE9BQWxDLENBQTBDLFdBQVc7QUFDbkQsWUFBSSxjQUFjLENBQWxCLEVBQXFCO0FBQ25CLGNBQUksYUFBYSxvQkFBTyxRQUFRLEdBQVIsRUFBUCxDQUFqQjtBQUNBLGVBQUssT0FBTCxDQUFhLFFBQWIsQ0FBc0IsR0FBdEIsQ0FBMEIsT0FBMUIsRUFBbUMsRUFBQyxTQUFTLFVBQVYsRUFBc0IsT0FBTyxTQUE3QixFQUF3QyxTQUFTLFNBQVMsSUFBVCxLQUFrQixLQUFuRSxFQUFuQztBQUNEO0FBQ0QsWUFBSSxtQkFBbUIsUUFBUSxPQUFSLENBQWdCLFNBQWhCLENBQXZCO0FBQ0Esa0JBQVUsR0FBVixDQUFjLGdCQUFkLEVBQWdDLG9DQUF3QixPQUF4QixDQUFoQztBQUNELE9BUEQ7QUFRRCxLQVREO0FBVUQ7QUFDRCwwQkFBd0IsUUFBeEIsRUFBa0MsU0FBbEMsRUFBNkMsU0FBN0MsRUFBd0Q7QUFDdEQsdUNBQWdCLFNBQVMsSUFBekIsRUFBK0IsT0FBL0IsQ0FBdUMsV0FBVztBQUNoRCxVQUFJLGNBQWMsQ0FBbEIsRUFBcUI7QUFDbkIsWUFBSSxhQUFhLG9CQUFPLFFBQVEsR0FBUixFQUFQLENBQWpCO0FBQ0EsYUFBSyxPQUFMLENBQWEsUUFBYixDQUFzQixHQUF0QixDQUEwQixPQUExQixFQUFtQyxFQUFDLFNBQVMsVUFBVixFQUFzQixPQUFPLFNBQTdCLEVBQXdDLFNBQVMsS0FBakQsRUFBbkM7QUFDRDtBQUNELFVBQUksbUJBQW1CLFFBQVEsT0FBUixDQUFnQixTQUFoQixDQUF2QjtBQUNBLGdCQUFVLEdBQVYsQ0FBYyxnQkFBZCxFQUFnQyxvQ0FBd0IsT0FBeEIsQ0FBaEM7QUFDRCxLQVBEO0FBUUQ7QUFDRCxRQUFNLE9BQU4sRUFBZSxTQUFmLEVBQTBCLFNBQTFCLEVBQXFDO0FBQ25DLFlBQVEsSUFBUixDQUFhLE9BQWIsQ0FBcUIsWUFBWTtBQUMvQixVQUFJLHlDQUE2QixRQUE3QixDQUFKLEVBQTRDO0FBQzFDLGFBQUsseUJBQUwsQ0FBK0IsU0FBUyxXQUF4QyxFQUFxRCxTQUFyRCxFQUFnRSxTQUFoRTtBQUNEO0FBQ0YsS0FKRDtBQUtBLFdBQU8sU0FBUDtBQUNEO0FBQ0QsU0FBTyxPQUFQLEVBQWdCLFNBQWhCLEVBQTJCLFNBQTNCLEVBQXNDO0FBQ3BDLFFBQUksV0FBVyxRQUFRLElBQVIsQ0FBYSxNQUFiLENBQW9CLEVBQUUsVUFBRiwrQkFBcEIsRUFBMEQsR0FBMUQsQ0FBOEQsWUFBWTtBQUN2RixpQkFBVyxTQUFTLEdBQVQsRUFBWDtBQUNBLFVBQUksMkNBQStCLFFBQS9CLENBQUosRUFBOEM7QUFDNUMsYUFBSywyQkFBTCxDQUFpQyxTQUFTLFdBQTFDLEVBQXVELFNBQXZELEVBQWtFLFNBQWxFO0FBQ0QsT0FGRCxNQUVPLElBQUksa0NBQXNCLFFBQXRCLENBQUosRUFBcUM7QUFDMUMsYUFBSyx1QkFBTCxDQUE2QixRQUE3QixFQUF1QyxTQUF2QyxFQUFrRCxTQUFsRDtBQUNEO0FBQ0QsYUFBTyxRQUFQO0FBQ0QsS0FSYyxDQUFmO0FBU0EsUUFBSSxpQkFBaUIsbUNBQWtCLFFBQWxCLEVBQTRCLEVBQUUsS0FBRixDQUFRLEtBQUssT0FBYixFQUFzQixFQUFDLE9BQU8sU0FBUixFQUFtQixPQUFPLFNBQTFCLEVBQXRCLENBQTVCLENBQXJCO0FBQ0EsV0FBTyxTQUFQO0FBQ0Q7QUFoSWU7UUFrSUksTSxHQUFkLFU7UUFDZSxPLEdBQWYsVyIsImZpbGUiOiJtb2R1bGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgRW52IGZyb20gXCIuL2VudlwiO1xuaW1wb3J0IFN0b3JlIGZyb20gXCIuL3N0b3JlXCI7XG5pbXBvcnQgUmVhZGVyIGZyb20gXCIuL3NoaWZ0LXJlYWRlclwiO1xuaW1wb3J0IFRva2VuRXhwYW5kZXIgZnJvbSBcIi4vdG9rZW4tZXhwYW5kZXIuanNcIjtcbmltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlci5qc1wiO1xuaW1wb3J0IEJpbmRpbmdNYXAgZnJvbSBcIi4vYmluZGluZy1tYXAuanNcIjtcbmltcG9ydCB7Z2Vuc3ltfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCBUZXJtLCB7aXNFT0YsIGlzQmluZGluZ0lkZW50aWZpZXIsIGlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgaXNGdW5jdGlvbkV4cHJlc3Npb24sIGlzRnVuY3Rpb25UZXJtLCBpc0Z1bmN0aW9uV2l0aE5hbWUsIGlzU3ludGF4RGVjbGFyYXRpb24sIGlzU3ludGF4cmVjRGVjbGFyYXRpb24sIGlzVmFyaWFibGVEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50LCBpc0ltcG9ydCwgaXNFeHBvcnQsIGlzRXhwb3J0RnJvbSwgaXNFeHBvcnRBbGxGcm9tLCBpc0V4cG9ydERlZmF1bHQsIGlzRXhwb3J0U3ludGF4LCBpc1N5bnRheERlY2xhcmF0aW9uU3RhdGVtZW50LCBpc1ByYWdtYSwgaXNDb21waWxldGltZURlY2xhcmF0aW9uLCBpc0NvbXBpbGV0aW1lU3RhdGVtZW50LCBpc0NsYXNzRGVjbGFyYXRpb259IGZyb20gXCIuL3Rlcm1zXCI7XG5pbXBvcnQge2V2YWxDb21waWxldGltZVZhbHVlLCBldmFsUnVudGltZVZhbHVlc30gZnJvbSBcIi4vbG9hZC1zeW50YXhcIjtcbmltcG9ydCBDb21waWxlciBmcm9tIFwiLi9jb21waWxlclwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IHtTY29wZSwgZnJlc2hTY29wZX0gZnJvbSBcIi4vc2NvcGVcIjtcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiLi9lcnJvcnNcIjtcbmltcG9ydCB7Y29sbGVjdEJpbmRpbmdzfSBmcm9tIFwiLi9oeWdpZW5lLXV0aWxzXCI7XG5pbXBvcnQge0FMTF9QSEFTRVN9IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGRpcm5hbWUgZnJvbSBcInV0aWxzLWRpcm5hbWVcIjtcbmltcG9ydCAgKiBhcyBfIGZyb20gXCJyYW1kYVwiO1xuY2xhc3MgTW9kdWxlXzQyMyB7XG4gIGNvbnN0cnVjdG9yKG1vZHVsZVNwZWNpZmllcl80MjgsIGlzTmF0aXZlXzQyOSwgaW1wb3J0RW50cmllc180MzAsIGV4cG9ydEVudHJpZXNfNDMxLCBwcmFnbWFzXzQzMiwgYm9keV80MzMpIHtcbiAgICB0aGlzLm1vZHVsZVNwZWNpZmllciA9IG1vZHVsZVNwZWNpZmllcl80Mjg7XG4gICAgdGhpcy5pc05hdGl2ZSA9IGlzTmF0aXZlXzQyOTtcbiAgICB0aGlzLmltcG9ydEVudHJpZXMgPSBpbXBvcnRFbnRyaWVzXzQzMDtcbiAgICB0aGlzLmV4cG9ydEVudHJpZXMgPSBleHBvcnRFbnRyaWVzXzQzMTtcbiAgICB0aGlzLnByYWdtYXMgPSBwcmFnbWFzXzQzMjtcbiAgICB0aGlzLmJvZHkgPSBib2R5XzQzMztcbiAgfVxufVxuY29uc3QgZmluZEJpbmRpbmdJZGVudGlmaWVyTmFtZV80MjQgPSB0ZXJtXzQzNCA9PiB7XG4gIGFzc2VydCh0ZXJtXzQzNC5uYW1lLCBgbm90IGltcGxlbWVudGVkIHlldCBmb3IgdHlwZSAke3Rlcm1fNDM0LnR5cGV9YCk7XG4gIHJldHVybiB0ZXJtXzQzNC5uYW1lO1xufTtcbmNvbnN0IGNvbnZlcnRFeHBvcnRfNDI1ID0gdGVybV80MzUgPT4ge1xuICBsZXQgZGVjbGFyYXRpb25fNDM2ID0gdGVybV80MzUuZGVjbGFyYXRpb247XG4gIGxldCBiaW5kaW5nc180MzcgPSBbXTtcbiAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbihkZWNsYXJhdGlvbl80MzYpKSB7XG4gICAgYmluZGluZ3NfNDM3ID0gZGVjbGFyYXRpb25fNDM2LmRlY2xhcmF0b3JzLm1hcChkZWNsXzQzOSA9PiBmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQyNChkZWNsXzQzOS5iaW5kaW5nKSk7XG4gIH0gZWxzZSBpZiAoaXNGdW5jdGlvbkRlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQzNikgfHwgaXNDbGFzc0RlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQzNikpIHtcbiAgICBiaW5kaW5nc180MzcucHVzaChmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQyNChkZWNsYXJhdGlvbl80MzYubmFtZSkpO1xuICB9XG4gIGxldCBuYW1lZEV4cG9ydHNfNDM4ID0gYmluZGluZ3NfNDM3Lm1hcChiaW5kaW5nXzQ0MCA9PiB7XG4gICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwb3J0U3BlY2lmaWVyXCIsIHtuYW1lOiBudWxsLCBleHBvcnRlZE5hbWU6IGJpbmRpbmdfNDQwfSk7XG4gIH0pO1xuICByZXR1cm4gbmV3IFRlcm0oXCJFeHBvcnRGcm9tXCIsIHttb2R1bGVTcGVjaWZpZXI6IG51bGwsIG5hbWVkRXhwb3J0czogTGlzdChuYW1lZEV4cG9ydHNfNDM4KX0pO1xufTtcbmNvbnN0IHByYWdtYVJlZ2VwXzQyNiA9IC9eXFxzKiNcXHcqLztcbmNsYXNzIE1vZHVsZXNfNDI3IHtcbiAgY29uc3RydWN0b3IoY29udGV4dF80NDEpIHtcbiAgICB0aGlzLmNvbXBpbGVkTW9kdWxlcyA9IG5ldyBNYXA7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dF80NDE7XG4gICAgdGhpcy5jb250ZXh0Lm1vZHVsZXMgPSB0aGlzO1xuICB9XG4gIGxvYWRTdHJpbmcoc3RyXzQ0MiwgY2hlY2tQcmFnbWFfNDQzID0gdHJ1ZSkge1xuICAgIGxldCBoYXNQcmFnbWFfNDQ0ID0gcHJhZ21hUmVnZXBfNDI2LnRlc3Qoc3RyXzQ0Mik7XG4gICAgaWYgKGNoZWNrUHJhZ21hXzQ0MyAmJiAhaGFzUHJhZ21hXzQ0NCkge1xuICAgICAgcmV0dXJuIHtpc05hdGl2ZTogdHJ1ZSwgYm9keTogTGlzdCgpfTtcbiAgICB9XG4gICAgcmV0dXJuIHtpc05hdGl2ZTogIWhhc1ByYWdtYV80NDQsIGJvZHk6IG5ldyBSZWFkZXIoc3RyXzQ0MikucmVhZCgpfTtcbiAgfVxuICBsb2FkKHBhdGhfNDQ1KSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZFN0cmluZyh0aGlzLmNvbnRleHQubW9kdWxlTG9hZGVyKHBhdGhfNDQ1KSk7XG4gIH1cbiAgY29tcGlsZShtb2RfNDQ2LCBwYXRoXzQ0Nykge1xuICAgIGxldCBzdHhsXzQ0OCA9IG1vZF80NDYuYm9keTtcbiAgICBsZXQgb3V0U2NvcGVfNDQ5ID0gZnJlc2hTY29wZShcIm91dHNpZGVFZGdlXCIpO1xuICAgIGxldCBpblNjb3BlXzQ1MCA9IGZyZXNoU2NvcGUoYGluc2lkZUVkZ2UwYCk7XG4gICAgbGV0IGNvbXBpbGVyXzQ1MSA9IG5ldyBDb21waWxlcigwLCBuZXcgRW52LCBuZXcgU3RvcmUsIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7Y3VycmVudFNjb3BlOiBbb3V0U2NvcGVfNDQ5LCBpblNjb3BlXzQ1MF0sIGN3ZDogcGF0aF80NDcgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHRoaXMuY29udGV4dC5jd2QgOiBkaXJuYW1lKHBhdGhfNDQ3KX0pKTtcbiAgICBsZXQgdGVybXNfNDUyID0gY29tcGlsZXJfNDUxLmNvbXBpbGUoc3R4bF80NDgubWFwKHNfNDU3ID0+IHNfNDU3LmFkZFNjb3BlKG91dFNjb3BlXzQ0OSwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCBBTExfUEhBU0VTKS5hZGRTY29wZShpblNjb3BlXzQ1MCwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCAwKSkpO1xuICAgIGxldCBpbXBvcnRFbnRyaWVzXzQ1MyA9IFtdO1xuICAgIGxldCBleHBvcnRFbnRyaWVzXzQ1NCA9IFtdO1xuICAgIGxldCBwcmFnbWFzXzQ1NSA9IFtdO1xuICAgIGxldCBmaWx0ZXJlZFRlcm1zXzQ1NiA9IHRlcm1zXzQ1Mi5yZWR1Y2UoKGFjY180NTgsIHRfNDU5KSA9PiB7XG4gICAgICByZXR1cm4gXy5jb25kKFtbaXNJbXBvcnQsIHRfNDYwID0+IHtcbiAgICAgICAgaW1wb3J0RW50cmllc180NTMucHVzaCh0XzQ2MCk7XG4gICAgICAgIHJldHVybiBhY2NfNDU4O1xuICAgICAgfV0sIFtpc0V4cG9ydCwgdF80NjEgPT4ge1xuICAgICAgICBpZiAodF80NjEuZGVjbGFyYXRpb24pIHtcbiAgICAgICAgICBleHBvcnRFbnRyaWVzXzQ1NC5wdXNoKGNvbnZlcnRFeHBvcnRfNDI1KHRfNDYxKSk7XG4gICAgICAgICAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbih0XzQ2MS5kZWNsYXJhdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBhY2NfNDU4LmNvbmNhdChuZXcgVGVybShcIlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnRcIiwge2RlY2xhcmF0aW9uOiB0XzQ2MS5kZWNsYXJhdGlvbn0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFjY180NTguY29uY2F0KHRfNDYxLmRlY2xhcmF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBleHBvcnRFbnRyaWVzXzQ1NC5wdXNoKHRfNDYxKTtcbiAgICAgICAgcmV0dXJuIGFjY180NTg7XG4gICAgICB9XSwgW2lzUHJhZ21hLCB0XzQ2MiA9PiB7XG4gICAgICAgIHByYWdtYXNfNDU1LnB1c2godF80NjIpO1xuICAgICAgICByZXR1cm4gYWNjXzQ1ODtcbiAgICAgIH1dLCBbXy5ULCB0XzQ2MyA9PiBhY2NfNDU4LmNvbmNhdCh0XzQ2MyldXSkodF80NTkpO1xuICAgIH0sIExpc3QoKSk7XG4gICAgcmV0dXJuIG5ldyBNb2R1bGVfNDIzKHBhdGhfNDQ3LCBtb2RfNDQ2LmlzTmF0aXZlLCBMaXN0KGltcG9ydEVudHJpZXNfNDUzKSwgTGlzdChleHBvcnRFbnRyaWVzXzQ1NCksIExpc3QocHJhZ21hc180NTUpLCBmaWx0ZXJlZFRlcm1zXzQ1Nik7XG4gIH1cbiAgY29tcGlsZUVudHJ5cG9pbnQoc291cmNlXzQ2NCwgZmlsZW5hbWVfNDY1LCBlbmZvcmNlUHJhZ21hXzQ2NiA9IGZhbHNlKSB7XG4gICAgbGV0IHN0eGxfNDY3ID0gdGhpcy5sb2FkU3RyaW5nKHNvdXJjZV80NjQsIGZhbHNlKTtcbiAgICBpZiAoZW5mb3JjZVByYWdtYV80NjYgJiYgc3R4bF80NjcuaXNOYXRpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRW50cnlwb2ludCAke2ZpbGVuYW1lXzQ2NX0gbXVzdCBiZWdpbiB3aXRoICNsYW5nIHByYWdtYWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBdFBoYXNlKFwiPDxlbnRyeXBvaW50Pj5cIiwgMCwgdGhpcy5jb250ZXh0LmN3ZCwgc3R4bF80NjcpO1xuICB9XG4gIGdldEF0UGhhc2UocmF3UGF0aF80NjgsIHBoYXNlXzQ2OSwgY3dkXzQ3MCwgcmF3U3R4bF80NzEgPSBudWxsKSB7XG4gICAgbGV0IHBhdGhfNDcyID0gcmF3UGF0aF80NjggPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHJhd1BhdGhfNDY4IDogdGhpcy5jb250ZXh0Lm1vZHVsZVJlc29sdmVyKHJhd1BhdGhfNDY4LCBjd2RfNDcwKTtcbiAgICBsZXQgbWFwS2V5XzQ3MyA9IGAke3BhdGhfNDcyfToke3BoYXNlXzQ2OX1gO1xuICAgIGlmICghdGhpcy5jb21waWxlZE1vZHVsZXMuaGFzKG1hcEtleV80NzMpKSB7XG4gICAgICBpZiAocGhhc2VfNDY5ID09PSAwKSB7XG4gICAgICAgIGxldCBzdHhsID0gcmF3U3R4bF80NzEgIT0gbnVsbCA/IHJhd1N0eGxfNDcxIDogdGhpcy5sb2FkKHBhdGhfNDcyKTtcbiAgICAgICAgdGhpcy5jb21waWxlZE1vZHVsZXMuc2V0KG1hcEtleV80NzMsIHRoaXMuY29tcGlsZShzdHhsLCBwYXRoXzQ3MikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHJhd01vZCA9IHRoaXMuZ2V0QXRQaGFzZShyYXdQYXRoXzQ2OCwgMCwgY3dkXzQ3MCwgcmF3U3R4bF80NzEpO1xuICAgICAgICBsZXQgc2NvcGUgPSBmcmVzaFNjb3BlKGBpbnNpZGVFZGdlJHtwaGFzZV80Njl9YCk7XG4gICAgICAgIHRoaXMuY29tcGlsZWRNb2R1bGVzLnNldChtYXBLZXlfNDczLCBuZXcgTW9kdWxlXzQyMyhyYXdNb2QubW9kdWxlU3BlY2lmaWVyLCBmYWxzZSwgcmF3TW9kLmltcG9ydEVudHJpZXMubWFwKHRlcm1fNDc0ID0+IHRlcm1fNDc0LmFkZFNjb3BlKHNjb3BlLCB0aGlzLmNvbnRleHQuYmluZGluZ3MsIHBoYXNlXzQ2OSkpLCByYXdNb2QuZXhwb3J0RW50cmllcy5tYXAodGVybV80NzUgPT4gdGVybV80NzUuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNDY5KSksIHJhd01vZC5wcmFnbWFzLCByYXdNb2QuYm9keS5tYXAodGVybV80NzYgPT4gdGVybV80NzYuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNDY5KSkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmdldChtYXBLZXlfNDczKTtcbiAgfVxuICBoYXMocmF3UGF0aF80NzcsIHBoYXNlXzQ3OCA9IDApIHtcbiAgICBsZXQgcGF0aF80NzkgPSByYXdQYXRoXzQ3NyA9PT0gXCI8PGVudHJ5cG9pbnQ+PlwiID8gcmF3UGF0aF80NzcgOiB0aGlzLmNvbnRleHQubW9kdWxlUmVzb2x2ZXIocmF3UGF0aF80NzcsIHRoaXMuY29udGV4dC5jd2QpO1xuICAgIGxldCBrZXlfNDgwID0gYCR7cGF0aF80Nzl9OiR7cGhhc2VfNDc4fWA7XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmhhcyhrZXlfNDgwKSAmJiAhdGhpcy5jb21waWxlZE1vZHVsZXMuZ2V0KGtleV80ODApLmlzTmF0aXZlO1xuICB9XG4gIHJlZ2lzdGVyU3ludGF4RGVjbGFyYXRpb24odGVybV80ODEsIHBoYXNlXzQ4Miwgc3RvcmVfNDgzKSB7XG4gICAgdGVybV80ODEuZGVjbGFyYXRvcnMuZm9yRWFjaChkZWNsXzQ4NCA9PiB7XG4gICAgICBsZXQgdmFsXzQ4NSA9IGV2YWxDb21waWxldGltZVZhbHVlKGRlY2xfNDg0LmluaXQuZ2VuKCksIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7cGhhc2U6IHBoYXNlXzQ4MiArIDEsIHN0b3JlOiBzdG9yZV80ODN9KSk7XG4gICAgICBjb2xsZWN0QmluZGluZ3MoZGVjbF80ODQuYmluZGluZykuZm9yRWFjaChzdHhfNDg2ID0+IHtcbiAgICAgICAgaWYgKHBoYXNlXzQ4MiAhPT0gMCkge1xuICAgICAgICAgIGxldCBuZXdCaW5kaW5nID0gZ2Vuc3ltKHN0eF80ODYudmFsKCkpO1xuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzQ4Niwge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV80ODIsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV80ODcgPSBzdHhfNDg2LnJlc29sdmUocGhhc2VfNDgyKTtcbiAgICAgICAgc3RvcmVfNDgzLnNldChyZXNvbHZlZE5hbWVfNDg3LCBuZXcgQ29tcGlsZXRpbWVUcmFuc2Zvcm0odmFsXzQ4NSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcmVnaXN0ZXJWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fNDg4LCBwaGFzZV80ODksIHN0b3JlXzQ5MCkge1xuICAgIHRlcm1fNDg4LmRlY2xhcmF0b3JzLmZvckVhY2goZGVjbF80OTEgPT4ge1xuICAgICAgY29sbGVjdEJpbmRpbmdzKGRlY2xfNDkxLmJpbmRpbmcpLmZvckVhY2goc3R4XzQ5MiA9PiB7XG4gICAgICAgIGlmIChwaGFzZV80ODkgIT09IDApIHtcbiAgICAgICAgICBsZXQgbmV3QmluZGluZyA9IGdlbnN5bShzdHhfNDkyLnZhbCgpKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQuYmluZGluZ3MuYWRkKHN0eF80OTIsIHtiaW5kaW5nOiBuZXdCaW5kaW5nLCBwaGFzZTogcGhhc2VfNDg5LCBza2lwRHVwOiB0ZXJtXzQ4OC5raW5kID09PSBcInZhclwifSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV80OTMgPSBzdHhfNDkyLnJlc29sdmUocGhhc2VfNDg5KTtcbiAgICAgICAgc3RvcmVfNDkwLnNldChyZXNvbHZlZE5hbWVfNDkzLCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNDkyKSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICByZWdpc3RlckZ1bmN0aW9uT3JDbGFzcyh0ZXJtXzQ5NCwgcGhhc2VfNDk1LCBzdG9yZV80OTYpIHtcbiAgICBjb2xsZWN0QmluZGluZ3ModGVybV80OTQubmFtZSkuZm9yRWFjaChzdHhfNDk3ID0+IHtcbiAgICAgIGlmIChwaGFzZV80OTUgIT09IDApIHtcbiAgICAgICAgbGV0IG5ld0JpbmRpbmcgPSBnZW5zeW0oc3R4XzQ5Ny52YWwoKSk7XG4gICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzQ5Nywge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV80OTUsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICB9XG4gICAgICBsZXQgcmVzb2x2ZWROYW1lXzQ5OCA9IHN0eF80OTcucmVzb2x2ZShwaGFzZV80OTUpO1xuICAgICAgc3RvcmVfNDk2LnNldChyZXNvbHZlZE5hbWVfNDk4LCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNDk3KSk7XG4gICAgfSk7XG4gIH1cbiAgdmlzaXQobW9kXzQ5OSwgcGhhc2VfNTAwLCBzdG9yZV81MDEpIHtcbiAgICBtb2RfNDk5LmJvZHkuZm9yRWFjaCh0ZXJtXzUwMiA9PiB7XG4gICAgICBpZiAoaXNTeW50YXhEZWNsYXJhdGlvblN0YXRlbWVudCh0ZXJtXzUwMikpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN5bnRheERlY2xhcmF0aW9uKHRlcm1fNTAyLmRlY2xhcmF0aW9uLCBwaGFzZV81MDAsIHN0b3JlXzUwMSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN0b3JlXzUwMTtcbiAgfVxuICBpbnZva2UobW9kXzUwMywgcGhhc2VfNTA0LCBzdG9yZV81MDUpIHtcbiAgICBsZXQgYm9keV81MDYgPSBtb2RfNTAzLmJvZHkuZmlsdGVyKF8uY29tcGxlbWVudChpc0NvbXBpbGV0aW1lU3RhdGVtZW50KSkubWFwKHRlcm1fNTA4ID0+IHtcbiAgICAgIHRlcm1fNTA4ID0gdGVybV81MDguZ2VuKCk7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50KHRlcm1fNTA4KSkge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtXzUwOC5kZWNsYXJhdGlvbiwgcGhhc2VfNTA0LCBzdG9yZV81MDUpO1xuICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uRGVjbGFyYXRpb24odGVybV81MDgpKSB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybV81MDgsIHBoYXNlXzUwNCwgc3RvcmVfNTA1KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0ZXJtXzUwODtcbiAgICB9KTtcbiAgICBsZXQgZXhwb3J0c09ial81MDcgPSBldmFsUnVudGltZVZhbHVlcyhib2R5XzUwNiwgXy5tZXJnZSh0aGlzLmNvbnRleHQsIHtzdG9yZTogc3RvcmVfNTA1LCBwaGFzZTogcGhhc2VfNTA0fSkpO1xuICAgIHJldHVybiBzdG9yZV81MDU7XG4gIH1cbn1cbmV4cG9ydCB7TW9kdWxlXzQyMyBhcyBNb2R1bGV9O1xuZXhwb3J0IHtNb2R1bGVzXzQyNyBhcyBNb2R1bGVzfSJdfQ==