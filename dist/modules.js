"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Modules = exports.Module = undefined;

var _immutable = require("immutable");

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _tokenExpander = require("./token-expander.js");

var _tokenExpander2 = _interopRequireDefault(_tokenExpander);

var _termExpander = require("./term-expander.js");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _symbol = require("./symbol");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _loadSyntax = require("./load-syntax");

var _compiler = require("./compiler");

var _compiler2 = _interopRequireDefault(_compiler);

var _transforms = require("./transforms");

var _scope = require("./scope");

var _errors = require("./errors");

var _hygieneUtils = require("./hygiene-utils");

var _syntax = require("./syntax");

var _utilsDirname = require("utils-dirname");

var _utilsDirname2 = _interopRequireDefault(_utilsDirname);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Module_463 {
  constructor(moduleSpecifier_468, isNative_469, importEntries_470, exportEntries_471, pragmas_472, body_473) {
    this.moduleSpecifier = moduleSpecifier_468;
    this.isNative = isNative_469;
    this.importEntries = importEntries_470;
    this.exportEntries = exportEntries_471;
    this.pragmas = pragmas_472;
    this.body = body_473;
  }
}
const findBindingIdentifierName_464 = term_474 => {
  (0, _errors.assert)(term_474.name, `not implemented yet for type ${ term_474.type }`);
  return term_474.name;
};
const convertExport_465 = term_475 => {
  let declaration_476 = term_475.declaration;
  let bindings_477 = [];
  if ((0, _terms.isVariableDeclaration)(declaration_476)) {
    bindings_477 = declaration_476.declarators.map(decl_479 => findBindingIdentifierName_464(decl_479.binding));
  } else if ((0, _terms.isFunctionDeclaration)(declaration_476) || (0, _terms.isClassDeclaration)(declaration_476)) {
    bindings_477.push(findBindingIdentifierName_464(declaration_476.name));
  }
  let namedExports_478 = bindings_477.map(binding_480 => {
    return new _terms2.default("ExportSpecifier", { name: null, exportedName: binding_480 });
  });
  return new _terms2.default("ExportFrom", { moduleSpecifier: null, namedExports: (0, _immutable.List)(namedExports_478) });
};
const pragmaRegep_466 = /^\s*#\w*/;
class Modules_467 {
  constructor(context_481) {
    this.compiledModules = new Map();
    this.context = context_481;
    this.context.modules = this;
  }
  loadString(str_482) {
    let checkPragma_483 = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    let hasPragma_484 = pragmaRegep_466.test(str_482);
    if (checkPragma_483 && !hasPragma_484) {
      return { isNative: true, body: (0, _immutable.List)() };
    }
    return { isNative: !hasPragma_484, body: new _shiftReader2.default(str_482).read() };
  }
  load(path_485) {
    return this.loadString(this.context.moduleLoader(path_485));
  }
  compile(mod_486, path_487) {
    let stxl_488 = mod_486.body;
    let outScope_489 = (0, _scope.freshScope)("outsideEdge");
    let inScope_490 = (0, _scope.freshScope)(`insideEdge0`);
    let compiler_491 = new _compiler2.default(0, new _env2.default(), new _store2.default(), _.merge(this.context, { currentScope: [outScope_489, inScope_490], cwd: path_487 === "<<entrypoint>>" ? this.context.cwd : (0, _utilsDirname2.default)(path_487) }));
    let terms_492 = compiler_491.compile(stxl_488.map(s_497 => s_497.addScope(outScope_489, this.context.bindings, _syntax.ALL_PHASES).addScope(inScope_490, this.context.bindings, 0)));
    let importEntries_493 = [];
    let exportEntries_494 = [];
    let pragmas_495 = [];
    let filteredTerms_496 = terms_492.reduce((acc_498, t_499) => {
      return _.cond([[_terms.isImport, t_500 => {
        importEntries_493.push(t_500);
        return acc_498;
      }], [_terms.isExport, t_501 => {
        if (t_501.declaration) {
          exportEntries_494.push(convertExport_465(t_501));
          if ((0, _terms.isVariableDeclaration)(t_501.declaration)) {
            return acc_498.concat(new _terms2.default("VariableDeclarationStatement", { declaration: t_501.declaration }));
          }
          return acc_498.concat(t_501.declaration);
        }
        exportEntries_494.push(t_501);
        return acc_498;
      }], [_terms.isPragma, t_502 => {
        pragmas_495.push(t_502);
        return acc_498;
      }], [_.T, t_503 => acc_498.concat(t_503)]])(t_499);
    }, (0, _immutable.List)());
    return new Module_463(path_487, mod_486.isNative, (0, _immutable.List)(importEntries_493), (0, _immutable.List)(exportEntries_494), (0, _immutable.List)(pragmas_495), filteredTerms_496);
  }
  compileEntrypoint(source_504, filename_505) {
    let enforcePragma_506 = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

    let stxl_507 = this.loadString(source_504, false);
    if (enforcePragma_506 && stxl_507.isNative) {
      throw new Error(`Entrypoint ${ filename_505 } must begin with #lang pragma`);
    }
    return this.getAtPhase("<<entrypoint>>", 0, this.context.cwd, stxl_507);
  }
  getAtPhase(rawPath_508, phase_509, cwd_510) {
    let rawStxl_511 = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

    let path_512 = rawPath_508 === "<<entrypoint>>" ? rawPath_508 : this.context.moduleResolver(rawPath_508, cwd_510);
    let mapKey_513 = `${ path_512 }:${ phase_509 }`;
    if (!this.compiledModules.has(mapKey_513)) {
      if (phase_509 === 0) {
        let stxl = rawStxl_511 != null ? rawStxl_511 : this.load(path_512);
        this.compiledModules.set(mapKey_513, this.compile(stxl, path_512));
      } else {
        let rawMod = this.getAtPhase(rawPath_508, 0, cwd_510, rawStxl_511);
        let scope = (0, _scope.freshScope)(`insideEdge${ phase_509 }`);
        this.compiledModules.set(mapKey_513, new Module_463(rawMod.moduleSpecifier, false, rawMod.importEntries.map(term_514 => term_514.addScope(scope, this.context.bindings, phase_509)), rawMod.exportEntries.map(term_515 => term_515.addScope(scope, this.context.bindings, phase_509)), rawMod.pragmas, rawMod.body.map(term_516 => term_516.addScope(scope, this.context.bindings, phase_509))));
      }
    }
    return this.compiledModules.get(mapKey_513);
  }
  has(rawPath_517) {
    let phase_518 = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

    let path_519 = rawPath_517 === "<<entrypoint>>" ? rawPath_517 : this.context.moduleResolver(rawPath_517, this.context.cwd);
    let key_520 = `${ path_519 }:${ phase_518 }`;
    return this.compiledModules.has(key_520) && !this.compiledModules.get(key_520).isNative;
  }
  registerSyntaxDeclaration(term_521, phase_522, store_523) {
    term_521.declarators.forEach(decl_524 => {
      let val_525 = (0, _loadSyntax.evalCompiletimeValue)(decl_524.init.gen(), _.merge(this.context, { phase: phase_522 + 1, store: store_523 }));
      (0, _hygieneUtils.collectBindings)(decl_524.binding).forEach(stx_526 => {
        if (phase_522 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_526.val());
          this.context.bindings.add(stx_526, { binding: newBinding, phase: phase_522, skipDup: false });
        }
        let resolvedName_527 = stx_526.resolve(phase_522);
        store_523.set(resolvedName_527, new _transforms.CompiletimeTransform(val_525));
      });
    });
  }
  registerVariableDeclaration(term_528, phase_529, store_530) {
    term_528.declarators.forEach(decl_531 => {
      (0, _hygieneUtils.collectBindings)(decl_531.binding).forEach(stx_532 => {
        if (phase_529 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_532.val());
          this.context.bindings.add(stx_532, { binding: newBinding, phase: phase_529, skipDup: term_528.kind === "var" });
        }
        let resolvedName_533 = stx_532.resolve(phase_529);
        store_530.set(resolvedName_533, new _transforms.VarBindingTransform(stx_532));
      });
    });
  }
  registerFunctionOrClass(term_534, phase_535, store_536) {
    (0, _hygieneUtils.collectBindings)(term_534.name).forEach(stx_537 => {
      if (phase_535 !== 0) {
        let newBinding = (0, _symbol.gensym)(stx_537.val());
        this.context.bindings.add(stx_537, { binding: newBinding, phase: phase_535, skipDup: false });
      }
      let resolvedName_538 = stx_537.resolve(phase_535);
      store_536.set(resolvedName_538, new _transforms.VarBindingTransform(stx_537));
    });
  }
  visit(mod_539, phase_540, store_541) {
    mod_539.body.forEach(term_542 => {
      if ((0, _terms.isSyntaxDeclarationStatement)(term_542)) {
        this.registerSyntaxDeclaration(term_542.declaration, phase_540, store_541);
      }
    });
    return store_541;
  }
  invoke(mod_543, phase_544, store_545) {
    let body_546 = mod_543.body.filter(_.complement(_terms.isCompiletimeStatement)).map(term_548 => {
      term_548 = term_548.gen();
      if ((0, _terms.isVariableDeclarationStatement)(term_548)) {
        this.registerVariableDeclaration(term_548.declaration, phase_544, store_545);
      } else if ((0, _terms.isFunctionDeclaration)(term_548)) {
        this.registerFunctionOrClass(term_548, phase_544, store_545);
      }
      return term_548;
    });
    let exportsObj_547 = (0, _loadSyntax.evalRuntimeValues)(body_546, _.merge(this.context, { store: store_545, phase: phase_544 }));
    return store_545;
  }
}
exports.Module = Module_463;
exports.Modules = Modules_467;
//# sourceMappingURL=data:application/json;base64,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LEVBQTRDO0FBQzFDLGFBQUsseUJBQUwsQ0FBK0IsU0FBUyxXQUF4QyxFQUFxRCxTQUFyRCxFQUFnRSxTQUFoRTtBQUNEO0FBQ0YsS0FKRDtBQUtBLFdBQU8sU0FBUDtBQUNEO0FBQ0QsU0FBTyxPQUFQLEVBQWdCLFNBQWhCLEVBQTJCLFNBQTNCLEVBQXNDO0FBQ3BDLFFBQUksV0FBVyxRQUFRLElBQVIsQ0FBYSxNQUFiLENBQW9CLEVBQUUsVUFBRiwrQkFBcEIsRUFBMEQsR0FBMUQsQ0FBOEQsWUFBWTtBQUN2RixpQkFBVyxTQUFTLEdBQVQsRUFBWDtBQUNBLFVBQUksMkNBQStCLFFBQS9CLENBQUosRUFBOEM7QUFDNUMsYUFBSywyQkFBTCxDQUFpQyxTQUFTLFdBQTFDLEVBQXVELFNBQXZELEVBQWtFLFNBQWxFO0FBQ0QsT0FGRCxNQUVPLElBQUksa0NBQXNCLFFBQXRCLENBQUosRUFBcUM7QUFDMUMsYUFBSyx1QkFBTCxDQUE2QixRQUE3QixFQUF1QyxTQUF2QyxFQUFrRCxTQUFsRDtBQUNEO0FBQ0QsYUFBTyxRQUFQO0FBQ0QsS0FSYyxDQUFmO0FBU0EsUUFBSSxpQkFBaUIsbUNBQWtCLFFBQWxCLEVBQTRCLEVBQUUsS0FBRixDQUFRLEtBQUssT0FBYixFQUFzQixFQUFDLE9BQU8sU0FBUixFQUFtQixPQUFPLFNBQTFCLEVBQXRCLENBQTVCLENBQXJCO0FBQ0EsV0FBTyxTQUFQO0FBQ0Q7QUFoSWU7UUFrSUksTSxHQUFkLFU7UUFDZSxPLEdBQWYsVyIsImZpbGUiOiJtb2R1bGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgRW52IGZyb20gXCIuL2VudlwiO1xuaW1wb3J0IFN0b3JlIGZyb20gXCIuL3N0b3JlXCI7XG5pbXBvcnQgUmVhZGVyIGZyb20gXCIuL3NoaWZ0LXJlYWRlclwiO1xuaW1wb3J0IFRva2VuRXhwYW5kZXIgZnJvbSBcIi4vdG9rZW4tZXhwYW5kZXIuanNcIjtcbmltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlci5qc1wiO1xuaW1wb3J0IEJpbmRpbmdNYXAgZnJvbSBcIi4vYmluZGluZy1tYXAuanNcIjtcbmltcG9ydCB7Z2Vuc3ltfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCBUZXJtLCB7aXNFT0YsIGlzQmluZGluZ0lkZW50aWZpZXIsIGlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgaXNGdW5jdGlvbkV4cHJlc3Npb24sIGlzRnVuY3Rpb25UZXJtLCBpc0Z1bmN0aW9uV2l0aE5hbWUsIGlzU3ludGF4RGVjbGFyYXRpb24sIGlzU3ludGF4cmVjRGVjbGFyYXRpb24sIGlzVmFyaWFibGVEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50LCBpc0ltcG9ydCwgaXNFeHBvcnQsIGlzRXhwb3J0RnJvbSwgaXNFeHBvcnRBbGxGcm9tLCBpc0V4cG9ydERlZmF1bHQsIGlzRXhwb3J0U3ludGF4LCBpc1N5bnRheERlY2xhcmF0aW9uU3RhdGVtZW50LCBpc1ByYWdtYSwgaXNDb21waWxldGltZURlY2xhcmF0aW9uLCBpc0NvbXBpbGV0aW1lU3RhdGVtZW50LCBpc0NsYXNzRGVjbGFyYXRpb259IGZyb20gXCIuL3Rlcm1zXCI7XG5pbXBvcnQge2V2YWxDb21waWxldGltZVZhbHVlLCBldmFsUnVudGltZVZhbHVlc30gZnJvbSBcIi4vbG9hZC1zeW50YXhcIjtcbmltcG9ydCBDb21waWxlciBmcm9tIFwiLi9jb21waWxlclwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IHtTY29wZSwgZnJlc2hTY29wZX0gZnJvbSBcIi4vc2NvcGVcIjtcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiLi9lcnJvcnNcIjtcbmltcG9ydCB7Y29sbGVjdEJpbmRpbmdzfSBmcm9tIFwiLi9oeWdpZW5lLXV0aWxzXCI7XG5pbXBvcnQge0FMTF9QSEFTRVN9IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGRpcm5hbWUgZnJvbSBcInV0aWxzLWRpcm5hbWVcIjtcbmltcG9ydCAgKiBhcyBfIGZyb20gXCJyYW1kYVwiO1xuY2xhc3MgTW9kdWxlXzQ2MyB7XG4gIGNvbnN0cnVjdG9yKG1vZHVsZVNwZWNpZmllcl80NjgsIGlzTmF0aXZlXzQ2OSwgaW1wb3J0RW50cmllc180NzAsIGV4cG9ydEVudHJpZXNfNDcxLCBwcmFnbWFzXzQ3MiwgYm9keV80NzMpIHtcbiAgICB0aGlzLm1vZHVsZVNwZWNpZmllciA9IG1vZHVsZVNwZWNpZmllcl80Njg7XG4gICAgdGhpcy5pc05hdGl2ZSA9IGlzTmF0aXZlXzQ2OTtcbiAgICB0aGlzLmltcG9ydEVudHJpZXMgPSBpbXBvcnRFbnRyaWVzXzQ3MDtcbiAgICB0aGlzLmV4cG9ydEVudHJpZXMgPSBleHBvcnRFbnRyaWVzXzQ3MTtcbiAgICB0aGlzLnByYWdtYXMgPSBwcmFnbWFzXzQ3MjtcbiAgICB0aGlzLmJvZHkgPSBib2R5XzQ3MztcbiAgfVxufVxuY29uc3QgZmluZEJpbmRpbmdJZGVudGlmaWVyTmFtZV80NjQgPSB0ZXJtXzQ3NCA9PiB7XG4gIGFzc2VydCh0ZXJtXzQ3NC5uYW1lLCBgbm90IGltcGxlbWVudGVkIHlldCBmb3IgdHlwZSAke3Rlcm1fNDc0LnR5cGV9YCk7XG4gIHJldHVybiB0ZXJtXzQ3NC5uYW1lO1xufTtcbmNvbnN0IGNvbnZlcnRFeHBvcnRfNDY1ID0gdGVybV80NzUgPT4ge1xuICBsZXQgZGVjbGFyYXRpb25fNDc2ID0gdGVybV80NzUuZGVjbGFyYXRpb247XG4gIGxldCBiaW5kaW5nc180NzcgPSBbXTtcbiAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbihkZWNsYXJhdGlvbl80NzYpKSB7XG4gICAgYmluZGluZ3NfNDc3ID0gZGVjbGFyYXRpb25fNDc2LmRlY2xhcmF0b3JzLm1hcChkZWNsXzQ3OSA9PiBmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQ2NChkZWNsXzQ3OS5iaW5kaW5nKSk7XG4gIH0gZWxzZSBpZiAoaXNGdW5jdGlvbkRlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ3NikgfHwgaXNDbGFzc0RlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ3NikpIHtcbiAgICBiaW5kaW5nc180NzcucHVzaChmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQ2NChkZWNsYXJhdGlvbl80NzYubmFtZSkpO1xuICB9XG4gIGxldCBuYW1lZEV4cG9ydHNfNDc4ID0gYmluZGluZ3NfNDc3Lm1hcChiaW5kaW5nXzQ4MCA9PiB7XG4gICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwb3J0U3BlY2lmaWVyXCIsIHtuYW1lOiBudWxsLCBleHBvcnRlZE5hbWU6IGJpbmRpbmdfNDgwfSk7XG4gIH0pO1xuICByZXR1cm4gbmV3IFRlcm0oXCJFeHBvcnRGcm9tXCIsIHttb2R1bGVTcGVjaWZpZXI6IG51bGwsIG5hbWVkRXhwb3J0czogTGlzdChuYW1lZEV4cG9ydHNfNDc4KX0pO1xufTtcbmNvbnN0IHByYWdtYVJlZ2VwXzQ2NiA9IC9eXFxzKiNcXHcqLztcbmNsYXNzIE1vZHVsZXNfNDY3IHtcbiAgY29uc3RydWN0b3IoY29udGV4dF80ODEpIHtcbiAgICB0aGlzLmNvbXBpbGVkTW9kdWxlcyA9IG5ldyBNYXA7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dF80ODE7XG4gICAgdGhpcy5jb250ZXh0Lm1vZHVsZXMgPSB0aGlzO1xuICB9XG4gIGxvYWRTdHJpbmcoc3RyXzQ4MiwgY2hlY2tQcmFnbWFfNDgzID0gdHJ1ZSkge1xuICAgIGxldCBoYXNQcmFnbWFfNDg0ID0gcHJhZ21hUmVnZXBfNDY2LnRlc3Qoc3RyXzQ4Mik7XG4gICAgaWYgKGNoZWNrUHJhZ21hXzQ4MyAmJiAhaGFzUHJhZ21hXzQ4NCkge1xuICAgICAgcmV0dXJuIHtpc05hdGl2ZTogdHJ1ZSwgYm9keTogTGlzdCgpfTtcbiAgICB9XG4gICAgcmV0dXJuIHtpc05hdGl2ZTogIWhhc1ByYWdtYV80ODQsIGJvZHk6IG5ldyBSZWFkZXIoc3RyXzQ4MikucmVhZCgpfTtcbiAgfVxuICBsb2FkKHBhdGhfNDg1KSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZFN0cmluZyh0aGlzLmNvbnRleHQubW9kdWxlTG9hZGVyKHBhdGhfNDg1KSk7XG4gIH1cbiAgY29tcGlsZShtb2RfNDg2LCBwYXRoXzQ4Nykge1xuICAgIGxldCBzdHhsXzQ4OCA9IG1vZF80ODYuYm9keTtcbiAgICBsZXQgb3V0U2NvcGVfNDg5ID0gZnJlc2hTY29wZShcIm91dHNpZGVFZGdlXCIpO1xuICAgIGxldCBpblNjb3BlXzQ5MCA9IGZyZXNoU2NvcGUoYGluc2lkZUVkZ2UwYCk7XG4gICAgbGV0IGNvbXBpbGVyXzQ5MSA9IG5ldyBDb21waWxlcigwLCBuZXcgRW52LCBuZXcgU3RvcmUsIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7Y3VycmVudFNjb3BlOiBbb3V0U2NvcGVfNDg5LCBpblNjb3BlXzQ5MF0sIGN3ZDogcGF0aF80ODcgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHRoaXMuY29udGV4dC5jd2QgOiBkaXJuYW1lKHBhdGhfNDg3KX0pKTtcbiAgICBsZXQgdGVybXNfNDkyID0gY29tcGlsZXJfNDkxLmNvbXBpbGUoc3R4bF80ODgubWFwKHNfNDk3ID0+IHNfNDk3LmFkZFNjb3BlKG91dFNjb3BlXzQ4OSwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCBBTExfUEhBU0VTKS5hZGRTY29wZShpblNjb3BlXzQ5MCwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCAwKSkpO1xuICAgIGxldCBpbXBvcnRFbnRyaWVzXzQ5MyA9IFtdO1xuICAgIGxldCBleHBvcnRFbnRyaWVzXzQ5NCA9IFtdO1xuICAgIGxldCBwcmFnbWFzXzQ5NSA9IFtdO1xuICAgIGxldCBmaWx0ZXJlZFRlcm1zXzQ5NiA9IHRlcm1zXzQ5Mi5yZWR1Y2UoKGFjY180OTgsIHRfNDk5KSA9PiB7XG4gICAgICByZXR1cm4gXy5jb25kKFtbaXNJbXBvcnQsIHRfNTAwID0+IHtcbiAgICAgICAgaW1wb3J0RW50cmllc180OTMucHVzaCh0XzUwMCk7XG4gICAgICAgIHJldHVybiBhY2NfNDk4O1xuICAgICAgfV0sIFtpc0V4cG9ydCwgdF81MDEgPT4ge1xuICAgICAgICBpZiAodF81MDEuZGVjbGFyYXRpb24pIHtcbiAgICAgICAgICBleHBvcnRFbnRyaWVzXzQ5NC5wdXNoKGNvbnZlcnRFeHBvcnRfNDY1KHRfNTAxKSk7XG4gICAgICAgICAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbih0XzUwMS5kZWNsYXJhdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBhY2NfNDk4LmNvbmNhdChuZXcgVGVybShcIlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnRcIiwge2RlY2xhcmF0aW9uOiB0XzUwMS5kZWNsYXJhdGlvbn0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFjY180OTguY29uY2F0KHRfNTAxLmRlY2xhcmF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBleHBvcnRFbnRyaWVzXzQ5NC5wdXNoKHRfNTAxKTtcbiAgICAgICAgcmV0dXJuIGFjY180OTg7XG4gICAgICB9XSwgW2lzUHJhZ21hLCB0XzUwMiA9PiB7XG4gICAgICAgIHByYWdtYXNfNDk1LnB1c2godF81MDIpO1xuICAgICAgICByZXR1cm4gYWNjXzQ5ODtcbiAgICAgIH1dLCBbXy5ULCB0XzUwMyA9PiBhY2NfNDk4LmNvbmNhdCh0XzUwMyldXSkodF80OTkpO1xuICAgIH0sIExpc3QoKSk7XG4gICAgcmV0dXJuIG5ldyBNb2R1bGVfNDYzKHBhdGhfNDg3LCBtb2RfNDg2LmlzTmF0aXZlLCBMaXN0KGltcG9ydEVudHJpZXNfNDkzKSwgTGlzdChleHBvcnRFbnRyaWVzXzQ5NCksIExpc3QocHJhZ21hc180OTUpLCBmaWx0ZXJlZFRlcm1zXzQ5Nik7XG4gIH1cbiAgY29tcGlsZUVudHJ5cG9pbnQoc291cmNlXzUwNCwgZmlsZW5hbWVfNTA1LCBlbmZvcmNlUHJhZ21hXzUwNiA9IGZhbHNlKSB7XG4gICAgbGV0IHN0eGxfNTA3ID0gdGhpcy5sb2FkU3RyaW5nKHNvdXJjZV81MDQsIGZhbHNlKTtcbiAgICBpZiAoZW5mb3JjZVByYWdtYV81MDYgJiYgc3R4bF81MDcuaXNOYXRpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRW50cnlwb2ludCAke2ZpbGVuYW1lXzUwNX0gbXVzdCBiZWdpbiB3aXRoICNsYW5nIHByYWdtYWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBdFBoYXNlKFwiPDxlbnRyeXBvaW50Pj5cIiwgMCwgdGhpcy5jb250ZXh0LmN3ZCwgc3R4bF81MDcpO1xuICB9XG4gIGdldEF0UGhhc2UocmF3UGF0aF81MDgsIHBoYXNlXzUwOSwgY3dkXzUxMCwgcmF3U3R4bF81MTEgPSBudWxsKSB7XG4gICAgbGV0IHBhdGhfNTEyID0gcmF3UGF0aF81MDggPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHJhd1BhdGhfNTA4IDogdGhpcy5jb250ZXh0Lm1vZHVsZVJlc29sdmVyKHJhd1BhdGhfNTA4LCBjd2RfNTEwKTtcbiAgICBsZXQgbWFwS2V5XzUxMyA9IGAke3BhdGhfNTEyfToke3BoYXNlXzUwOX1gO1xuICAgIGlmICghdGhpcy5jb21waWxlZE1vZHVsZXMuaGFzKG1hcEtleV81MTMpKSB7XG4gICAgICBpZiAocGhhc2VfNTA5ID09PSAwKSB7XG4gICAgICAgIGxldCBzdHhsID0gcmF3U3R4bF81MTEgIT0gbnVsbCA/IHJhd1N0eGxfNTExIDogdGhpcy5sb2FkKHBhdGhfNTEyKTtcbiAgICAgICAgdGhpcy5jb21waWxlZE1vZHVsZXMuc2V0KG1hcEtleV81MTMsIHRoaXMuY29tcGlsZShzdHhsLCBwYXRoXzUxMikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHJhd01vZCA9IHRoaXMuZ2V0QXRQaGFzZShyYXdQYXRoXzUwOCwgMCwgY3dkXzUxMCwgcmF3U3R4bF81MTEpO1xuICAgICAgICBsZXQgc2NvcGUgPSBmcmVzaFNjb3BlKGBpbnNpZGVFZGdlJHtwaGFzZV81MDl9YCk7XG4gICAgICAgIHRoaXMuY29tcGlsZWRNb2R1bGVzLnNldChtYXBLZXlfNTEzLCBuZXcgTW9kdWxlXzQ2MyhyYXdNb2QubW9kdWxlU3BlY2lmaWVyLCBmYWxzZSwgcmF3TW9kLmltcG9ydEVudHJpZXMubWFwKHRlcm1fNTE0ID0+IHRlcm1fNTE0LmFkZFNjb3BlKHNjb3BlLCB0aGlzLmNvbnRleHQuYmluZGluZ3MsIHBoYXNlXzUwOSkpLCByYXdNb2QuZXhwb3J0RW50cmllcy5tYXAodGVybV81MTUgPT4gdGVybV81MTUuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNTA5KSksIHJhd01vZC5wcmFnbWFzLCByYXdNb2QuYm9keS5tYXAodGVybV81MTYgPT4gdGVybV81MTYuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNTA5KSkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmdldChtYXBLZXlfNTEzKTtcbiAgfVxuICBoYXMocmF3UGF0aF81MTcsIHBoYXNlXzUxOCA9IDApIHtcbiAgICBsZXQgcGF0aF81MTkgPSByYXdQYXRoXzUxNyA9PT0gXCI8PGVudHJ5cG9pbnQ+PlwiID8gcmF3UGF0aF81MTcgOiB0aGlzLmNvbnRleHQubW9kdWxlUmVzb2x2ZXIocmF3UGF0aF81MTcsIHRoaXMuY29udGV4dC5jd2QpO1xuICAgIGxldCBrZXlfNTIwID0gYCR7cGF0aF81MTl9OiR7cGhhc2VfNTE4fWA7XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmhhcyhrZXlfNTIwKSAmJiAhdGhpcy5jb21waWxlZE1vZHVsZXMuZ2V0KGtleV81MjApLmlzTmF0aXZlO1xuICB9XG4gIHJlZ2lzdGVyU3ludGF4RGVjbGFyYXRpb24odGVybV81MjEsIHBoYXNlXzUyMiwgc3RvcmVfNTIzKSB7XG4gICAgdGVybV81MjEuZGVjbGFyYXRvcnMuZm9yRWFjaChkZWNsXzUyNCA9PiB7XG4gICAgICBsZXQgdmFsXzUyNSA9IGV2YWxDb21waWxldGltZVZhbHVlKGRlY2xfNTI0LmluaXQuZ2VuKCksIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7cGhhc2U6IHBoYXNlXzUyMiArIDEsIHN0b3JlOiBzdG9yZV81MjN9KSk7XG4gICAgICBjb2xsZWN0QmluZGluZ3MoZGVjbF81MjQuYmluZGluZykuZm9yRWFjaChzdHhfNTI2ID0+IHtcbiAgICAgICAgaWYgKHBoYXNlXzUyMiAhPT0gMCkge1xuICAgICAgICAgIGxldCBuZXdCaW5kaW5nID0gZ2Vuc3ltKHN0eF81MjYudmFsKCkpO1xuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzUyNiwge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV81MjIsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV81MjcgPSBzdHhfNTI2LnJlc29sdmUocGhhc2VfNTIyKTtcbiAgICAgICAgc3RvcmVfNTIzLnNldChyZXNvbHZlZE5hbWVfNTI3LCBuZXcgQ29tcGlsZXRpbWVUcmFuc2Zvcm0odmFsXzUyNSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcmVnaXN0ZXJWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fNTI4LCBwaGFzZV81MjksIHN0b3JlXzUzMCkge1xuICAgIHRlcm1fNTI4LmRlY2xhcmF0b3JzLmZvckVhY2goZGVjbF81MzEgPT4ge1xuICAgICAgY29sbGVjdEJpbmRpbmdzKGRlY2xfNTMxLmJpbmRpbmcpLmZvckVhY2goc3R4XzUzMiA9PiB7XG4gICAgICAgIGlmIChwaGFzZV81MjkgIT09IDApIHtcbiAgICAgICAgICBsZXQgbmV3QmluZGluZyA9IGdlbnN5bShzdHhfNTMyLnZhbCgpKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQuYmluZGluZ3MuYWRkKHN0eF81MzIsIHtiaW5kaW5nOiBuZXdCaW5kaW5nLCBwaGFzZTogcGhhc2VfNTI5LCBza2lwRHVwOiB0ZXJtXzUyOC5raW5kID09PSBcInZhclwifSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV81MzMgPSBzdHhfNTMyLnJlc29sdmUocGhhc2VfNTI5KTtcbiAgICAgICAgc3RvcmVfNTMwLnNldChyZXNvbHZlZE5hbWVfNTMzLCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTMyKSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICByZWdpc3RlckZ1bmN0aW9uT3JDbGFzcyh0ZXJtXzUzNCwgcGhhc2VfNTM1LCBzdG9yZV81MzYpIHtcbiAgICBjb2xsZWN0QmluZGluZ3ModGVybV81MzQubmFtZSkuZm9yRWFjaChzdHhfNTM3ID0+IHtcbiAgICAgIGlmIChwaGFzZV81MzUgIT09IDApIHtcbiAgICAgICAgbGV0IG5ld0JpbmRpbmcgPSBnZW5zeW0oc3R4XzUzNy52YWwoKSk7XG4gICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzUzNywge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV81MzUsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICB9XG4gICAgICBsZXQgcmVzb2x2ZWROYW1lXzUzOCA9IHN0eF81MzcucmVzb2x2ZShwaGFzZV81MzUpO1xuICAgICAgc3RvcmVfNTM2LnNldChyZXNvbHZlZE5hbWVfNTM4LCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTM3KSk7XG4gICAgfSk7XG4gIH1cbiAgdmlzaXQobW9kXzUzOSwgcGhhc2VfNTQwLCBzdG9yZV81NDEpIHtcbiAgICBtb2RfNTM5LmJvZHkuZm9yRWFjaCh0ZXJtXzU0MiA9PiB7XG4gICAgICBpZiAoaXNTeW50YXhEZWNsYXJhdGlvblN0YXRlbWVudCh0ZXJtXzU0MikpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN5bnRheERlY2xhcmF0aW9uKHRlcm1fNTQyLmRlY2xhcmF0aW9uLCBwaGFzZV81NDAsIHN0b3JlXzU0MSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN0b3JlXzU0MTtcbiAgfVxuICBpbnZva2UobW9kXzU0MywgcGhhc2VfNTQ0LCBzdG9yZV81NDUpIHtcbiAgICBsZXQgYm9keV81NDYgPSBtb2RfNTQzLmJvZHkuZmlsdGVyKF8uY29tcGxlbWVudChpc0NvbXBpbGV0aW1lU3RhdGVtZW50KSkubWFwKHRlcm1fNTQ4ID0+IHtcbiAgICAgIHRlcm1fNTQ4ID0gdGVybV81NDguZ2VuKCk7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50KHRlcm1fNTQ4KSkge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtXzU0OC5kZWNsYXJhdGlvbiwgcGhhc2VfNTQ0LCBzdG9yZV81NDUpO1xuICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uRGVjbGFyYXRpb24odGVybV81NDgpKSB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybV81NDgsIHBoYXNlXzU0NCwgc3RvcmVfNTQ1KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0ZXJtXzU0ODtcbiAgICB9KTtcbiAgICBsZXQgZXhwb3J0c09ial81NDcgPSBldmFsUnVudGltZVZhbHVlcyhib2R5XzU0NiwgXy5tZXJnZSh0aGlzLmNvbnRleHQsIHtzdG9yZTogc3RvcmVfNTQ1LCBwaGFzZTogcGhhc2VfNTQ0fSkpO1xuICAgIHJldHVybiBzdG9yZV81NDU7XG4gIH1cbn1cbmV4cG9ydCB7TW9kdWxlXzQ2MyBhcyBNb2R1bGV9O1xuZXhwb3J0IHtNb2R1bGVzXzQ2NyBhcyBNb2R1bGVzfSJdfQ==