"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compile = exports.parse = exports.expand = undefined;

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _parseReducer = require("./parse-reducer");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _scope = require("./scope");

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _modules = require("./modules");

var _babelCore = require("babel-core");

var _nodeModuleResolver = require("./node-module-resolver");

var _nodeModuleResolver2 = _interopRequireDefault(_nodeModuleResolver);

var _nodeModuleLoader = require("./node-module-loader");

var _nodeModuleLoader2 = _interopRequireDefault(_nodeModuleLoader);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function expand_791(source_794) {
  let options_795 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let bindings_796 = new _bindingMap2.default();
  let modules_797 = new _modules.Modules({ bindings: bindings_796, cwd: options_795.cwd || process.cwd(), filename: options_795.filename, transform: options_795.transform || _babelCore.transform || function (c_800) {
      return { code: c_800 };
    }, moduleResolver: options_795.moduleResolver || _nodeModuleResolver2.default, moduleLoader: options_795.moduleLoader || _nodeModuleLoader2.default });
  let compiledMod_798 = modules_797.compileEntrypoint(source_794, options_795.filename, options_795.enforcePragma);
  let nativeImports_799 = compiledMod_798.importEntries.filter(imp_801 => !modules_797.has(imp_801.moduleSpecifier.val()));
  return new _terms2.default("Module", { directives: (0, _immutable.List)(), items: nativeImports_799.concat(compiledMod_798.body).concat(compiledMod_798.exportEntries.interpose(new _terms2.default("EmptyStatement", {}))) });
}
function parse_792(source_802, options_803) {
  let includeImports_804 = arguments.length <= 2 || arguments[2] === undefined ? true : arguments[2];

  return (0, _shiftReducer2.default)(new _parseReducer2.default({ phase: 0 }), expand_791(source_802, options_803).gen({ includeImports: includeImports_804 }));
}
function compile_793(source_805) {
  let options_806 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let ast_807 = parse_792(source_805, options_806, options_806.includeImports);
  let gen_808 = (0, _shiftCodegen2.default)(ast_807, new _shiftCodegen.FormattedCodeGen());
  return options_806.transform && !options_806.noBabel ? options_806.transform(gen_808, { babelrc: true, filename: options_806.filename }) : { code: gen_808 };
}
exports.expand = expand_791;
exports.parse = parse_792;
exports.compile = compile_793;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3N3ZWV0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBQ0EsU0FBUyxVQUFULENBQW9CLFVBQXBCLEVBQWtEO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDaEQsTUFBSSxlQUFlLDBCQUFuQjtBQUNBLE1BQUksY0FBYyxxQkFBWSxFQUFDLFVBQVUsWUFBWCxFQUF5QixLQUFLLFlBQVksR0FBWixJQUFtQixRQUFRLEdBQVIsRUFBakQsRUFBZ0UsVUFBVSxZQUFZLFFBQXRGLEVBQWdHLFdBQVcsWUFBWSxTQUFaLDRCQUEyQyxVQUFVLEtBQVYsRUFBaUI7QUFDbk0sYUFBTyxFQUFDLE1BQU0sS0FBUCxFQUFQO0FBQ0QsS0FGNkIsRUFFM0IsZ0JBQWdCLFlBQVksY0FBWixnQ0FGVyxFQUVpQyxjQUFjLFlBQVksWUFBWiw4QkFGL0MsRUFBWixDQUFsQjtBQUdBLE1BQUksa0JBQWtCLFlBQVksaUJBQVosQ0FBOEIsVUFBOUIsRUFBMEMsWUFBWSxRQUF0RCxFQUFnRSxZQUFZLGFBQTVFLENBQXRCO0FBQ0EsTUFBSSxvQkFBb0IsZ0JBQWdCLGFBQWhCLENBQThCLE1BQTlCLENBQXFDLFdBQVcsQ0FBQyxZQUFZLEdBQVosQ0FBZ0IsUUFBUSxlQUFSLENBQXdCLEdBQXhCLEVBQWhCLENBQWpELENBQXhCO0FBQ0EsU0FBTyxvQkFBUyxRQUFULEVBQW1CLEVBQUMsWUFBWSxzQkFBYixFQUFxQixPQUFPLGtCQUFrQixNQUFsQixDQUF5QixnQkFBZ0IsSUFBekMsRUFBK0MsTUFBL0MsQ0FBc0QsZ0JBQWdCLGFBQWhCLENBQThCLFNBQTlCLENBQXdDLG9CQUFTLGdCQUFULEVBQTJCLEVBQTNCLENBQXhDLENBQXRELENBQTVCLEVBQW5CLENBQVA7QUFDRDtBQUNELFNBQVMsU0FBVCxDQUFtQixVQUFuQixFQUErQixXQUEvQixFQUF1RTtBQUFBLE1BQTNCLGtCQUEyQix5REFBTixJQUFNOztBQUNyRSxTQUFPLDRCQUFPLDJCQUFpQixFQUFDLE9BQU8sQ0FBUixFQUFqQixDQUFQLEVBQXFDLFdBQVcsVUFBWCxFQUF1QixXQUF2QixFQUFvQyxHQUFwQyxDQUF3QyxFQUFDLGdCQUFnQixrQkFBakIsRUFBeEMsQ0FBckMsQ0FBUDtBQUNEO0FBQ0QsU0FBUyxXQUFULENBQXFCLFVBQXJCLEVBQW1EO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDakQsTUFBSSxVQUFVLFVBQVUsVUFBVixFQUFzQixXQUF0QixFQUFtQyxZQUFZLGNBQS9DLENBQWQ7QUFDQSxNQUFJLFVBQVUsNEJBQVEsT0FBUixFQUFpQixvQ0FBakIsQ0FBZDtBQUNBLFNBQU8sWUFBWSxTQUFaLElBQXlCLENBQUMsWUFBWSxPQUF0QyxHQUFnRCxZQUFZLFNBQVosQ0FBc0IsT0FBdEIsRUFBK0IsRUFBQyxTQUFTLElBQVYsRUFBZ0IsVUFBVSxZQUFZLFFBQXRDLEVBQS9CLENBQWhELEdBQWtJLEVBQUMsTUFBTSxPQUFQLEVBQXpJO0FBQ0Q7UUFDcUIsTSxHQUFkLFU7UUFDYSxLLEdBQWIsUztRQUNlLE8sR0FBZixXIiwiZmlsZSI6InN3ZWV0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWRlciBmcm9tIFwiLi9zaGlmdC1yZWFkZXJcIjtcbmltcG9ydCB7TGlzdH0gZnJvbSBcImltbXV0YWJsZVwiO1xuaW1wb3J0IFN5bnRheCBmcm9tIFwiLi9zeW50YXhcIjtcbmltcG9ydCBFbnYgZnJvbSBcIi4vZW52XCI7XG5pbXBvcnQgcmVkdWNlIGZyb20gXCJzaGlmdC1yZWR1Y2VyXCI7XG5pbXBvcnQgUGFyc2VSZWR1Y2VyIGZyb20gXCIuL3BhcnNlLXJlZHVjZXJcIjtcbmltcG9ydCBjb2RlZ2VuLCB7Rm9ybWF0dGVkQ29kZUdlbn0gZnJvbSBcInNoaWZ0LWNvZGVnZW5cIjtcbmltcG9ydCB7U2NvcGUsIGZyZXNoU2NvcGV9IGZyb20gXCIuL3Njb3BlXCI7XG5pbXBvcnQgQmluZGluZ01hcCBmcm9tIFwiLi9iaW5kaW5nLW1hcC5qc1wiO1xuaW1wb3J0IFRlcm0gZnJvbSBcIi4vdGVybXNcIjtcbmltcG9ydCB7TW9kdWxlc30gZnJvbSBcIi4vbW9kdWxlc1wiO1xuaW1wb3J0IHt0cmFuc2Zvcm0gYXMgYmFiZWxUcmFuc2Zvcm19IGZyb20gXCJiYWJlbC1jb3JlXCI7XG5pbXBvcnQgbm9kZVJlc29sdmVyIGZyb20gXCIuL25vZGUtbW9kdWxlLXJlc29sdmVyXCI7XG5pbXBvcnQgbm9kZUxvYWRlciBmcm9tIFwiLi9ub2RlLW1vZHVsZS1sb2FkZXJcIjtcbmZ1bmN0aW9uIGV4cGFuZF83OTEoc291cmNlXzc5NCwgb3B0aW9uc183OTUgPSB7fSkge1xuICBsZXQgYmluZGluZ3NfNzk2ID0gbmV3IEJpbmRpbmdNYXA7XG4gIGxldCBtb2R1bGVzXzc5NyA9IG5ldyBNb2R1bGVzKHtiaW5kaW5nczogYmluZGluZ3NfNzk2LCBjd2Q6IG9wdGlvbnNfNzk1LmN3ZCB8fCBwcm9jZXNzLmN3ZCgpLCBmaWxlbmFtZTogb3B0aW9uc183OTUuZmlsZW5hbWUsIHRyYW5zZm9ybTogb3B0aW9uc183OTUudHJhbnNmb3JtIHx8IGJhYmVsVHJhbnNmb3JtIHx8IGZ1bmN0aW9uIChjXzgwMCkge1xuICAgIHJldHVybiB7Y29kZTogY184MDB9O1xuICB9LCBtb2R1bGVSZXNvbHZlcjogb3B0aW9uc183OTUubW9kdWxlUmVzb2x2ZXIgfHwgbm9kZVJlc29sdmVyLCBtb2R1bGVMb2FkZXI6IG9wdGlvbnNfNzk1Lm1vZHVsZUxvYWRlciB8fCBub2RlTG9hZGVyfSk7XG4gIGxldCBjb21waWxlZE1vZF83OTggPSBtb2R1bGVzXzc5Ny5jb21waWxlRW50cnlwb2ludChzb3VyY2VfNzk0LCBvcHRpb25zXzc5NS5maWxlbmFtZSwgb3B0aW9uc183OTUuZW5mb3JjZVByYWdtYSk7XG4gIGxldCBuYXRpdmVJbXBvcnRzXzc5OSA9IGNvbXBpbGVkTW9kXzc5OC5pbXBvcnRFbnRyaWVzLmZpbHRlcihpbXBfODAxID0+ICFtb2R1bGVzXzc5Ny5oYXMoaW1wXzgwMS5tb2R1bGVTcGVjaWZpZXIudmFsKCkpKTtcbiAgcmV0dXJuIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBuYXRpdmVJbXBvcnRzXzc5OS5jb25jYXQoY29tcGlsZWRNb2RfNzk4LmJvZHkpLmNvbmNhdChjb21waWxlZE1vZF83OTguZXhwb3J0RW50cmllcy5pbnRlcnBvc2UobmV3IFRlcm0oXCJFbXB0eVN0YXRlbWVudFwiLCB7fSkpKX0pO1xufVxuZnVuY3Rpb24gcGFyc2VfNzkyKHNvdXJjZV84MDIsIG9wdGlvbnNfODAzLCBpbmNsdWRlSW1wb3J0c184MDQgPSB0cnVlKSB7XG4gIHJldHVybiByZWR1Y2UobmV3IFBhcnNlUmVkdWNlcih7cGhhc2U6IDB9KSwgZXhwYW5kXzc5MShzb3VyY2VfODAyLCBvcHRpb25zXzgwMykuZ2VuKHtpbmNsdWRlSW1wb3J0czogaW5jbHVkZUltcG9ydHNfODA0fSkpO1xufVxuZnVuY3Rpb24gY29tcGlsZV83OTMoc291cmNlXzgwNSwgb3B0aW9uc184MDYgPSB7fSkge1xuICBsZXQgYXN0XzgwNyA9IHBhcnNlXzc5Mihzb3VyY2VfODA1LCBvcHRpb25zXzgwNiwgb3B0aW9uc184MDYuaW5jbHVkZUltcG9ydHMpO1xuICBsZXQgZ2VuXzgwOCA9IGNvZGVnZW4oYXN0XzgwNywgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICByZXR1cm4gb3B0aW9uc184MDYudHJhbnNmb3JtICYmICFvcHRpb25zXzgwNi5ub0JhYmVsID8gb3B0aW9uc184MDYudHJhbnNmb3JtKGdlbl84MDgsIHtiYWJlbHJjOiB0cnVlLCBmaWxlbmFtZTogb3B0aW9uc184MDYuZmlsZW5hbWV9KSA6IHtjb2RlOiBnZW5fODA4fTtcbn1cbmV4cG9ydCB7ZXhwYW5kXzc5MSBhcyBleHBhbmR9O1xuZXhwb3J0IHtwYXJzZV83OTIgYXMgcGFyc2V9O1xuZXhwb3J0IHtjb21waWxlXzc5MyBhcyBjb21waWxlfSJdfQ==