"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compile = exports.parse = exports.expand = undefined;

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _parseReducer = require("./parse-reducer");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _scope = require("./scope");

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _modules = require("./modules");

var _babelCore = require("babel-core");

var _nodeModuleResolver = require("./node-module-resolver");

var _nodeModuleResolver2 = _interopRequireDefault(_nodeModuleResolver);

var _nodeModuleLoader = require("./node-module-loader");

var _nodeModuleLoader2 = _interopRequireDefault(_nodeModuleLoader);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function expand_760(source_763) {
  let options_764 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let bindings_765 = new _bindingMap2.default();
  let modules_766 = new _modules.Modules({ bindings: bindings_765, cwd: options_764.cwd || process.cwd(), filename: options_764.filename, transform: options_764.transform || _babelCore.transform || function (c_769) {
      return { code: c_769 };
    }, moduleResolver: options_764.moduleResolver || _nodeModuleResolver2.default, moduleLoader: options_764.moduleLoader || _nodeModuleLoader2.default });
  let compiledMod_767 = modules_766.compileEntrypoint(source_763, options_764.filename, options_764.enforcePragma);
  let nativeImports_768 = compiledMod_767.importEntries.filter(imp_770 => !modules_766.has(imp_770.moduleSpecifier.val()));
  return new _terms2.default("Module", { directives: (0, _immutable.List)(), items: nativeImports_768.concat(compiledMod_767.body).concat(compiledMod_767.exportEntries.interpose(new _terms2.default("EmptyStatement", {}))) });
}
function parse_761(source_771, options_772) {
  let includeImports_773 = arguments.length <= 2 || arguments[2] === undefined ? true : arguments[2];

  return (0, _shiftReducer2.default)(new _parseReducer2.default({ phase: 0 }), expand_760(source_771, options_772).gen({ includeImports: includeImports_773 }));
}
function compile_762(source_774) {
  let options_775 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let ast_776 = parse_761(source_774, options_775, options_775.includeImports);
  let gen_777 = (0, _shiftCodegen2.default)(ast_776, new _shiftCodegen.FormattedCodeGen());
  return options_775.transform && !options_775.noBabel ? options_775.transform(gen_777, { babelrc: true, filename: options_775.filename }) : { code: gen_777 };
}
exports.expand = expand_760;
exports.parse = parse_761;
exports.compile = compile_762;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3N3ZWV0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBQ0EsU0FBUyxVQUFULENBQW9CLFVBQXBCLEVBQWtEO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDaEQsTUFBSSxlQUFlLDBCQUFuQjtBQUNBLE1BQUksY0FBYyxxQkFBWSxFQUFDLFVBQVUsWUFBWCxFQUF5QixLQUFLLFlBQVksR0FBWixJQUFtQixRQUFRLEdBQVIsRUFBakQsRUFBZ0UsVUFBVSxZQUFZLFFBQXRGLEVBQWdHLFdBQVcsWUFBWSxTQUFaLDRCQUEyQyxVQUFVLEtBQVYsRUFBaUI7QUFDbk0sYUFBTyxFQUFDLE1BQU0sS0FBUCxFQUFQO0FBQ0QsS0FGNkIsRUFFM0IsZ0JBQWdCLFlBQVksY0FBWixnQ0FGVyxFQUVpQyxjQUFjLFlBQVksWUFBWiw4QkFGL0MsRUFBWixDQUFsQjtBQUdBLE1BQUksa0JBQWtCLFlBQVksaUJBQVosQ0FBOEIsVUFBOUIsRUFBMEMsWUFBWSxRQUF0RCxFQUFnRSxZQUFZLGFBQTVFLENBQXRCO0FBQ0EsTUFBSSxvQkFBb0IsZ0JBQWdCLGFBQWhCLENBQThCLE1BQTlCLENBQXFDLFdBQVcsQ0FBQyxZQUFZLEdBQVosQ0FBZ0IsUUFBUSxlQUFSLENBQXdCLEdBQXhCLEVBQWhCLENBQWpELENBQXhCO0FBQ0EsU0FBTyxvQkFBUyxRQUFULEVBQW1CLEVBQUMsWUFBWSxzQkFBYixFQUFxQixPQUFPLGtCQUFrQixNQUFsQixDQUF5QixnQkFBZ0IsSUFBekMsRUFBK0MsTUFBL0MsQ0FBc0QsZ0JBQWdCLGFBQWhCLENBQThCLFNBQTlCLENBQXdDLG9CQUFTLGdCQUFULEVBQTJCLEVBQTNCLENBQXhDLENBQXRELENBQTVCLEVBQW5CLENBQVA7QUFDRDtBQUNELFNBQVMsU0FBVCxDQUFtQixVQUFuQixFQUErQixXQUEvQixFQUF1RTtBQUFBLE1BQTNCLGtCQUEyQix5REFBTixJQUFNOztBQUNyRSxTQUFPLDRCQUFPLDJCQUFpQixFQUFDLE9BQU8sQ0FBUixFQUFqQixDQUFQLEVBQXFDLFdBQVcsVUFBWCxFQUF1QixXQUF2QixFQUFvQyxHQUFwQyxDQUF3QyxFQUFDLGdCQUFnQixrQkFBakIsRUFBeEMsQ0FBckMsQ0FBUDtBQUNEO0FBQ0QsU0FBUyxXQUFULENBQXFCLFVBQXJCLEVBQW1EO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDakQsTUFBSSxVQUFVLFVBQVUsVUFBVixFQUFzQixXQUF0QixFQUFtQyxZQUFZLGNBQS9DLENBQWQ7QUFDQSxNQUFJLFVBQVUsNEJBQVEsT0FBUixFQUFpQixvQ0FBakIsQ0FBZDtBQUNBLFNBQU8sWUFBWSxTQUFaLElBQXlCLENBQUMsWUFBWSxPQUF0QyxHQUFnRCxZQUFZLFNBQVosQ0FBc0IsT0FBdEIsRUFBK0IsRUFBQyxTQUFTLElBQVYsRUFBZ0IsVUFBVSxZQUFZLFFBQXRDLEVBQS9CLENBQWhELEdBQWtJLEVBQUMsTUFBTSxPQUFQLEVBQXpJO0FBQ0Q7UUFDcUIsTSxHQUFkLFU7UUFDYSxLLEdBQWIsUztRQUNlLE8sR0FBZixXIiwiZmlsZSI6InN3ZWV0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWRlciBmcm9tIFwiLi9zaGlmdC1yZWFkZXJcIjtcbmltcG9ydCB7TGlzdH0gZnJvbSBcImltbXV0YWJsZVwiO1xuaW1wb3J0IFN5bnRheCBmcm9tIFwiLi9zeW50YXhcIjtcbmltcG9ydCBFbnYgZnJvbSBcIi4vZW52XCI7XG5pbXBvcnQgcmVkdWNlIGZyb20gXCJzaGlmdC1yZWR1Y2VyXCI7XG5pbXBvcnQgUGFyc2VSZWR1Y2VyIGZyb20gXCIuL3BhcnNlLXJlZHVjZXJcIjtcbmltcG9ydCBjb2RlZ2VuLCB7Rm9ybWF0dGVkQ29kZUdlbn0gZnJvbSBcInNoaWZ0LWNvZGVnZW5cIjtcbmltcG9ydCB7U2NvcGUsIGZyZXNoU2NvcGV9IGZyb20gXCIuL3Njb3BlXCI7XG5pbXBvcnQgQmluZGluZ01hcCBmcm9tIFwiLi9iaW5kaW5nLW1hcC5qc1wiO1xuaW1wb3J0IFRlcm0gZnJvbSBcIi4vdGVybXNcIjtcbmltcG9ydCB7TW9kdWxlc30gZnJvbSBcIi4vbW9kdWxlc1wiO1xuaW1wb3J0IHt0cmFuc2Zvcm0gYXMgYmFiZWxUcmFuc2Zvcm19IGZyb20gXCJiYWJlbC1jb3JlXCI7XG5pbXBvcnQgbm9kZVJlc29sdmVyIGZyb20gXCIuL25vZGUtbW9kdWxlLXJlc29sdmVyXCI7XG5pbXBvcnQgbm9kZUxvYWRlciBmcm9tIFwiLi9ub2RlLW1vZHVsZS1sb2FkZXJcIjtcbmZ1bmN0aW9uIGV4cGFuZF83NjAoc291cmNlXzc2Mywgb3B0aW9uc183NjQgPSB7fSkge1xuICBsZXQgYmluZGluZ3NfNzY1ID0gbmV3IEJpbmRpbmdNYXA7XG4gIGxldCBtb2R1bGVzXzc2NiA9IG5ldyBNb2R1bGVzKHtiaW5kaW5nczogYmluZGluZ3NfNzY1LCBjd2Q6IG9wdGlvbnNfNzY0LmN3ZCB8fCBwcm9jZXNzLmN3ZCgpLCBmaWxlbmFtZTogb3B0aW9uc183NjQuZmlsZW5hbWUsIHRyYW5zZm9ybTogb3B0aW9uc183NjQudHJhbnNmb3JtIHx8IGJhYmVsVHJhbnNmb3JtIHx8IGZ1bmN0aW9uIChjXzc2OSkge1xuICAgIHJldHVybiB7Y29kZTogY183Njl9O1xuICB9LCBtb2R1bGVSZXNvbHZlcjogb3B0aW9uc183NjQubW9kdWxlUmVzb2x2ZXIgfHwgbm9kZVJlc29sdmVyLCBtb2R1bGVMb2FkZXI6IG9wdGlvbnNfNzY0Lm1vZHVsZUxvYWRlciB8fCBub2RlTG9hZGVyfSk7XG4gIGxldCBjb21waWxlZE1vZF83NjcgPSBtb2R1bGVzXzc2Ni5jb21waWxlRW50cnlwb2ludChzb3VyY2VfNzYzLCBvcHRpb25zXzc2NC5maWxlbmFtZSwgb3B0aW9uc183NjQuZW5mb3JjZVByYWdtYSk7XG4gIGxldCBuYXRpdmVJbXBvcnRzXzc2OCA9IGNvbXBpbGVkTW9kXzc2Ny5pbXBvcnRFbnRyaWVzLmZpbHRlcihpbXBfNzcwID0+ICFtb2R1bGVzXzc2Ni5oYXMoaW1wXzc3MC5tb2R1bGVTcGVjaWZpZXIudmFsKCkpKTtcbiAgcmV0dXJuIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBuYXRpdmVJbXBvcnRzXzc2OC5jb25jYXQoY29tcGlsZWRNb2RfNzY3LmJvZHkpLmNvbmNhdChjb21waWxlZE1vZF83NjcuZXhwb3J0RW50cmllcy5pbnRlcnBvc2UobmV3IFRlcm0oXCJFbXB0eVN0YXRlbWVudFwiLCB7fSkpKX0pO1xufVxuZnVuY3Rpb24gcGFyc2VfNzYxKHNvdXJjZV83NzEsIG9wdGlvbnNfNzcyLCBpbmNsdWRlSW1wb3J0c183NzMgPSB0cnVlKSB7XG4gIHJldHVybiByZWR1Y2UobmV3IFBhcnNlUmVkdWNlcih7cGhhc2U6IDB9KSwgZXhwYW5kXzc2MChzb3VyY2VfNzcxLCBvcHRpb25zXzc3MikuZ2VuKHtpbmNsdWRlSW1wb3J0czogaW5jbHVkZUltcG9ydHNfNzczfSkpO1xufVxuZnVuY3Rpb24gY29tcGlsZV83NjIoc291cmNlXzc3NCwgb3B0aW9uc183NzUgPSB7fSkge1xuICBsZXQgYXN0Xzc3NiA9IHBhcnNlXzc2MShzb3VyY2VfNzc0LCBvcHRpb25zXzc3NSwgb3B0aW9uc183NzUuaW5jbHVkZUltcG9ydHMpO1xuICBsZXQgZ2VuXzc3NyA9IGNvZGVnZW4oYXN0Xzc3NiwgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICByZXR1cm4gb3B0aW9uc183NzUudHJhbnNmb3JtICYmICFvcHRpb25zXzc3NS5ub0JhYmVsID8gb3B0aW9uc183NzUudHJhbnNmb3JtKGdlbl83NzcsIHtiYWJlbHJjOiB0cnVlLCBmaWxlbmFtZTogb3B0aW9uc183NzUuZmlsZW5hbWV9KSA6IHtjb2RlOiBnZW5fNzc3fTtcbn1cbmV4cG9ydCB7ZXhwYW5kXzc2MCBhcyBleHBhbmR9O1xuZXhwb3J0IHtwYXJzZV83NjEgYXMgcGFyc2V9O1xuZXhwb3J0IHtjb21waWxlXzc2MiBhcyBjb21waWxlfSJdfQ==