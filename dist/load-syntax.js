"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.evalCompiletimeValue = exports.evalRuntimeValues = exports.sanitizeReplacementValues = undefined;

var _termExpander = require("./term-expander");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _immutable = require("immutable");

var _parseReducer = require("./parse-reducer.js");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _serializer = require("./serializer");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _transforms = require("./transforms");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _macroContext = require("./macro-context");

var _templateProcessor = require("./template-processor");

var _vm = require("vm");

var _vm2 = _interopRequireDefault(_vm);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let geval_343 = eval;
function sanitizeReplacementValues_344(values_347) {
  if (Array.isArray(values_347)) {
    return sanitizeReplacementValues_344((0, _immutable.List)(values_347));
  } else if (_immutable.List.isList(values_347)) {
    return values_347.map(sanitizeReplacementValues_344);
  } else if (values_347 == null) {
    throw new Error("replacement values for syntax template must not be null or undefined");
  } else if (typeof values_347.next === "function") {
    return sanitizeReplacementValues_344((0, _immutable.List)(values_347));
  }
  return (0, _macroContext.unwrap)(values_347);
}
function evalRuntimeValues_345(terms_348, context_349) {
  let prepped_350 = terms_348.reduce((acc_356, term_357) => {
    let result_358 = (0, _immutable.List)();
    if ((0, _terms.isExport)(term_357)) {
      if ((0, _terms.isVariableDeclaration)(term_357.declaration)) {
        return acc_356.concat(new _terms2.default("VariableDeclarationStatement", { declaration: term_357.declaration })).concat(term_357.declaration.declarators.map(decl_359 => {
          return new _terms2.default("ExpressionStatement", { expression: new _terms2.default("AssignmentExpression", { binding: new _terms2.default("StaticMemberExpression", { object: new _terms2.default("IdentifierExpression", { name: _syntax2.default.fromIdentifier("exports") }), property: decl_359.binding.name }), expression: new _terms2.default("IdentifierExpression", { name: decl_359.binding.name }) }) });
        }));
      }
    } else if ((0, _terms.isImport)(term_357)) {
      return acc_356;
    }
    return acc_356.concat(term_357);
  }, (0, _immutable.List)());
  let parsed_351 = (0, _shiftReducer2.default)(new _parseReducer2.default(context_349, false), new _terms2.default("Module", { directives: (0, _immutable.List)(), items: prepped_350 }).gen({ includeImports: false }));
  let gen_352 = (0, _shiftCodegen2.default)(parsed_351, new _shiftCodegen.FormattedCodeGen());
  let result_353 = context_349.transform(gen_352, { babelrc: true, filename: context_349.filename });
  let exportsObj_354 = {};
  context_349.store.set("exports", exportsObj_354);
  let val_355 = _vm2.default.runInContext(result_353.code, context_349.store.getNodeContext());
  return exportsObj_354;
}
function evalCompiletimeValue_346(expr_360, context_361) {
  let deserializer_362 = (0, _serializer.makeDeserializer)(context_361.bindings);
  let sandbox_363 = { syntaxQuote: function syntaxQuote(strings_371) {
      for (var _len = arguments.length, values_370 = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        values_370[_key - 1] = arguments[_key];
      }

      let ctx_372 = deserializer_362.read(_.last(values_370));
      let reader_373 = new _shiftReader2.default(strings_371, ctx_372, _.take(values_370.length - 1, values_370));
      return reader_373.read();
    }, syntaxTemplate: function syntaxTemplate(str_375) {
      for (var _len2 = arguments.length, values_374 = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        values_374[_key2 - 1] = arguments[_key2];
      }

      return (0, _templateProcessor.replaceTemplate)(deserializer_362.read(str_375), sanitizeReplacementValues_344(values_374));
    } };
  let sandboxKeys_364 = (0, _immutable.List)(Object.keys(sandbox_363));
  let sandboxVals_365 = sandboxKeys_364.map(k_376 => sandbox_363[k_376]).toArray();
  let parsed_366 = (0, _shiftReducer2.default)(new _parseReducer2.default(context_361), new _terms2.default("Module", { directives: (0, _immutable.List)(), items: _immutable.List.of(new _terms2.default("ExpressionStatement", { expression: new _terms2.default("FunctionExpression", { isGenerator: false, name: null, params: new _terms2.default("FormalParameters", { items: sandboxKeys_364.map(param_377 => {
            return new _terms2.default("BindingIdentifier", { name: _syntax2.default.from("identifier", param_377) });
          }), rest: null }), body: new _terms2.default("FunctionBody", { directives: _immutable.List.of(new _terms2.default("Directive", { rawValue: "use strict" })), statements: _immutable.List.of(new _terms2.default("ReturnStatement", { expression: expr_360 })) }) }) })) }));
  let gen_367 = (0, _shiftCodegen2.default)(parsed_366, new _shiftCodegen.FormattedCodeGen());
  let result_368 = context_361.transform(gen_367, { babelrc: true, filename: context_361.filename });
  let val_369 = _vm2.default.runInContext(result_368.code, context_361.store.getNodeContext());
  return val_369.apply(undefined, sandboxVals_365);
}
exports.sanitizeReplacementValues = sanitizeReplacementValues_344;
exports.evalRuntimeValues = evalRuntimeValues_345;
exports.evalCompiletimeValue = evalCompiletimeValue_346;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L2xvYWQtc3ludGF4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0lBQWEsQzs7Ozs7O0FBQ2IsSUFBSSxZQUFZLElBQWhCO0FBQ0EsU0FBUyw2QkFBVCxDQUF1QyxVQUF2QyxFQUFtRDtBQUNqRCxNQUFJLE1BQU0sT0FBTixDQUFjLFVBQWQsQ0FBSixFQUErQjtBQUM3QixXQUFPLDhCQUE4QixxQkFBSyxVQUFMLENBQTlCLENBQVA7QUFDRCxHQUZELE1BRU8sSUFBSSxnQkFBSyxNQUFMLENBQVksVUFBWixDQUFKLEVBQTZCO0FBQ2xDLFdBQU8sV0FBVyxHQUFYLENBQWUsNkJBQWYsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJLGNBQWMsSUFBbEIsRUFBd0I7QUFDN0IsVUFBTSxJQUFJLEtBQUosQ0FBVSxzRUFBVixDQUFOO0FBQ0QsR0FGTSxNQUVBLElBQUksT0FBTyxXQUFXLElBQWxCLEtBQTJCLFVBQS9CLEVBQTJDO0FBQ2hELFdBQU8sOEJBQThCLHFCQUFLLFVBQUwsQ0FBOUIsQ0FBUDtBQUNEO0FBQ0QsU0FBTywwQkFBTyxVQUFQLENBQVA7QUFDRDtBQUNELFNBQVMscUJBQVQsQ0FBK0IsU0FBL0IsRUFBMEMsV0FBMUMsRUFBdUQ7QUFDckQsTUFBSSxjQUFjLFVBQVUsTUFBVixDQUFpQixDQUFDLE9BQUQsRUFBVSxRQUFWLEtBQXVCO0FBQ3hELFFBQUksYUFBYSxzQkFBakI7QUFDQSxRQUFJLHFCQUFTLFFBQVQsQ0FBSixFQUF3QjtBQUN0QixVQUFJLGtDQUFzQixTQUFTLFdBQS9CLENBQUosRUFBaUQ7QUFDL0MsZUFBTyxRQUFRLE1BQVIsQ0FBZSxvQkFBUyw4QkFBVCxFQUF5QyxFQUFDLGFBQWEsU0FBUyxXQUF2QixFQUF6QyxDQUFmLEVB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QixFQUFDLGFBQWEsS0FBZCxFQUFxQixNQUFNLElBQTNCLEVBQWlDLFFBQVEsb0JBQVMsa0JBQVQsRUFBNkIsRUFBQyxPQUFPLGdCQUFnQixHQUFoQixDQUFvQixhQUFhO0FBQ3hTLG1CQUFPLG9CQUFTLG1CQUFULEVBQThCLEVBQUMsTUFBTSxpQkFBTyxJQUFQLENBQVksWUFBWixFQUEwQixTQUExQixDQUFQLEVBQTlCLENBQVA7QUFDRCxXQUZ3USxDQUFSLEVBRTdQLE1BQU0sSUFGdVAsRUFBN0IsQ0FBekMsRUFFekssTUFBTSxvQkFBUyxjQUFULEVBQXlCLEVBQUMsWUFBWSxnQkFBSyxFQUFMLENBQVEsb0JBQVMsV0FBVCxFQUFzQixFQUFDLFVBQVUsWUFBWCxFQUF0QixDQUFSLENBQWIsRUFBdUUsWUFBWSxnQkFBSyxFQUFMLENBQVEsb0JBQVMsaUJBQVQsRUFBNEIsRUFBQyxZQUFZLFFBQWIsRUFBNUIsQ0FBUixDQUFuRixFQUF6QixDQUZtSyxFQUEvQixDQUFiLEVBQWhDLENBQVIsQ0FBNUIsRUFBbkIsQ0FBdkMsQ0FBakI7QUFHQSxNQUFJLFVBQVUsNEJBQVEsVUFBUixFQUFvQixvQ0FBcEIsQ0FBZDtBQUNBLE1BQUksYUFBYSxZQUFZLFNBQVosQ0FBc0IsT0FBdEIsRUFBK0IsRUFBQyxTQUFTLElBQVYsRUFBZ0IsVUFBVSxZQUFZLFFBQXRDLEVBQS9CLENBQWpCO0FBQ0EsTUFBSSxVQUFVLGFBQUcsWUFBSCxDQUFnQixXQUFXLElBQTNCLEVBQWlDLFlBQVksS0FBWixDQUFrQixjQUFsQixFQUFqQyxDQUFkO0FBQ0EsU0FBTyxRQUFRLEtBQVIsQ0FBYyxTQUFkLEVBQXlCLGVBQXpCLENBQVA7QUFDRDtRQUN3Qyx5QixHQUFqQyw2QjtRQUN5QixpQixHQUF6QixxQjtRQUM0QixvQixHQUE1Qix3QiIsImZpbGUiOiJsb2FkLXN5bnRheC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlclwiO1xuaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgUGFyc2VSZWR1Y2VyIGZyb20gXCIuL3BhcnNlLXJlZHVjZXIuanNcIjtcbmltcG9ydCByZWR1Y2VyLCB7TW9ub2lkYWxSZWR1Y2VyfSBmcm9tIFwic2hpZnQtcmVkdWNlclwiO1xuaW1wb3J0IHttYWtlRGVzZXJpYWxpemVyfSBmcm9tIFwiLi9zZXJpYWxpemVyXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGNvZGVnZW4sIHtGb3JtYXR0ZWRDb2RlR2VufSBmcm9tIFwic2hpZnQtY29kZWdlblwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IFRlcm0sIHtpc0VPRiwgaXNCaW5kaW5nSWRlbnRpZmllciwgaXNGdW5jdGlvbkRlY2xhcmF0aW9uLCBpc0Z1bmN0aW9uRXhwcmVzc2lvbiwgaXNGdW5jdGlvblRlcm0sIGlzRnVuY3Rpb25XaXRoTmFtZSwgaXNTeW50YXhEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uLCBpc1ZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnQsIGlzSW1wb3J0LCBpc0V4cG9ydH0gZnJvbSBcIi4vdGVybXNcIjtcbmltcG9ydCBSZWFkZXIgZnJvbSBcIi4vc2hpZnQtcmVhZGVyXCI7XG5pbXBvcnQge3Vud3JhcH0gZnJvbSBcIi4vbWFjcm8tY29udGV4dFwiO1xuaW1wb3J0IHtyZXBsYWNlVGVtcGxhdGV9IGZyb20gXCIuL3RlbXBsYXRlLXByb2Nlc3NvclwiO1xuaW1wb3J0IHZtIGZyb20gXCJ2bVwiO1xuaW1wb3J0ICAqIGFzIF8gZnJvbSBcInJhbWRhXCI7XG5sZXQgZ2V2YWxfMzQzID0gZXZhbDtcbmZ1bmN0aW9uIHNhbml0aXplUmVwbGFjZW1lbnRWYWx1ZXNfMzQ0KHZhbHVlc18zNDcpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzXzM0NykpIHtcbiAgICByZXR1cm4gc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNDQoTGlzdCh2YWx1ZXNfMzQ3KSk7XG4gIH0gZWxzZSBpZiAoTGlzdC5pc0xpc3QodmFsdWVzXzM0NykpIHtcbiAgICByZXR1cm4gdmFsdWVzXzM0Ny5tYXAoc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNDQpO1xuICB9IGVsc2UgaWYgKHZhbHVlc18zNDcgPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInJlcGxhY2VtZW50IHZhbHVlcyBmb3Igc3ludGF4IHRlbXBsYXRlIG11c3Qgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkXCIpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZXNfMzQ3Lm5leHQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHJldHVybiBzYW5pdGl6ZVJlcGxhY2VtZW50VmFsdWVzXzM0NChMaXN0KHZhbHVlc18zNDcpKTtcbiAgfVxuICByZXR1cm4gdW53cmFwKHZhbHVlc18zNDcpO1xufVxuZnVuY3Rpb24gZXZhbFJ1bnRpbWVWYWx1ZXNfMzQ1KHRlcm1zXzM0OCwgY29udGV4dF8zNDkpIHtcbiAgbGV0IHByZXBwZWRfMzUwID0gdGVybXNfMzQ4LnJlZHVjZSgoYWNjXzM1NiwgdGVybV8zNTcpID0+IHtcbiAgICBsZXQgcmVzdWx0XzM1OCA9IExpc3QoKTtcbiAgICBpZiAoaXNFeHBvcnQodGVybV8zNTcpKSB7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fMzU3LmRlY2xhcmF0aW9uKSkge1xuICAgICAgICByZXR1cm4gYWNjXzM1Ni5jb25jYXQobmV3IFRlcm0oXCJWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50XCIsIHtkZWNsYXJhdGlvbjogdGVybV8zNTcuZGVjbGFyYXRpb259KSkuY29uY2F0KHRlcm1fMzU3LmRlY2xhcmF0aW9uLmRlY2xhcmF0b3JzLm1hcChkZWNsXzM1OSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwcmVzc2lvblN0YXRlbWVudFwiLCB7ZXhwcmVzc2lvbjogbmV3IFRlcm0oXCJBc3NpZ25tZW50RXhwcmVzc2lvblwiLCB7YmluZGluZzogbmV3IFRlcm0oXCJTdGF0aWNNZW1iZXJFeHByZXNzaW9uXCIsIHtvYmplY3Q6IG5ldyBUZXJtKFwiSWRlbnRpZmllckV4cHJlc3Npb25cIiwge25hbWU6IFN5bnRheC5mcm9tSWRlbnRpZmllcihcImV4cG9ydHNcIil9KSwgcHJvcGVydHk6IGRlY2xfMzU5LmJpbmRpbmcubmFtZX0pLCBleHByZXNzaW9uOiBuZXcgVGVybShcIklkZW50aWZpZXJFeHByZXNzaW9uXCIsIHtuYW1lOiBkZWNsXzM1OS5iaW5kaW5nLm5hbWV9KX0pfSk7XG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzSW1wb3J0KHRlcm1fMzU3KSkge1xuICAgICAgcmV0dXJuIGFjY18zNTY7XG4gICAgfVxuICAgIHJldHVybiBhY2NfMzU2LmNvbmNhdCh0ZXJtXzM1Nyk7XG4gIH0sIExpc3QoKSk7XG4gIGxldCBwYXJzZWRfMzUxID0gcmVkdWNlcihuZXcgUGFyc2VSZWR1Y2VyKGNvbnRleHRfMzQ5LCBmYWxzZSksIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBwcmVwcGVkXzM1MH0pLmdlbih7aW5jbHVkZUltcG9ydHM6IGZhbHNlfSkpO1xuICBsZXQgZ2VuXzM1MiA9IGNvZGVnZW4ocGFyc2VkXzM1MSwgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICBsZXQgcmVzdWx0XzM1MyA9IGNvbnRleHRfMzQ5LnRyYW5zZm9ybShnZW5fMzUyLCB7YmFiZWxyYzogdHJ1ZSwgZmlsZW5hbWU6IGNvbnRleHRfMzQ5LmZpbGVuYW1lfSk7XG4gIGxldCBleHBvcnRzT2JqXzM1NCA9IHt9O1xuICBjb250ZXh0XzM0OS5zdG9yZS5zZXQoXCJleHBvcnRzXCIsIGV4cG9ydHNPYmpfMzU0KTtcbiAgbGV0IHZhbF8zNTUgPSB2bS5ydW5JbkNvbnRleHQocmVzdWx0XzM1My5jb2RlLCBjb250ZXh0XzM0OS5zdG9yZS5nZXROb2RlQ29udGV4dCgpKTtcbiAgcmV0dXJuIGV4cG9ydHNPYmpfMzU0O1xufVxuZnVuY3Rpb24gZXZhbENvbXBpbGV0aW1lVmFsdWVfMzQ2KGV4cHJfMzYwLCBjb250ZXh0XzM2MSkge1xuICBsZXQgZGVzZXJpYWxpemVyXzM2MiA9IG1ha2VEZXNlcmlhbGl6ZXIoY29udGV4dF8zNjEuYmluZGluZ3MpO1xuICBsZXQgc2FuZGJveF8zNjMgPSB7c3ludGF4UXVvdGU6IGZ1bmN0aW9uIChzdHJpbmdzXzM3MSwgLi4udmFsdWVzXzM3MCkge1xuICAgIGxldCBjdHhfMzcyID0gZGVzZXJpYWxpemVyXzM2Mi5yZWFkKF8ubGFzdCh2YWx1ZXNfMzcwKSk7XG4gICAgbGV0IHJlYWRlcl8zNzMgPSBuZXcgUmVhZGVyKHN0cmluZ3NfMzcxLCBjdHhfMzcyLCBfLnRha2UodmFsdWVzXzM3MC5sZW5ndGggLSAxLCB2YWx1ZXNfMzcwKSk7XG4gICAgcmV0dXJuIHJlYWRlcl8zNzMucmVhZCgpO1xuICB9LCBzeW50YXhUZW1wbGF0ZTogZnVuY3Rpb24gKHN0cl8zNzUsIC4uLnZhbHVlc18zNzQpIHtcbiAgICByZXR1cm4gcmVwbGFjZVRlbXBsYXRlKGRlc2VyaWFsaXplcl8zNjIucmVhZChzdHJfMzc1KSwgc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNDQodmFsdWVzXzM3NCkpO1xuICB9fTtcbiAgbGV0IHNhbmRib3hLZXlzXzM2NCA9IExpc3QoT2JqZWN0LmtleXMoc2FuZGJveF8zNjMpKTtcbiAgbGV0IHNhbmRib3hWYWxzXzM2NSA9IHNhbmRib3hLZXlzXzM2NC5tYXAoa18zNzYgPT4gc2FuZGJveF8zNjNba18zNzZdKS50b0FycmF5KCk7XG4gIGxldCBwYXJzZWRfMzY2ID0gcmVkdWNlcihuZXcgUGFyc2VSZWR1Y2VyKGNvbnRleHRfMzYxKSwgbmV3IFRlcm0oXCJNb2R1bGVcIiwge2RpcmVjdGl2ZXM6IExpc3QoKSwgaXRlbXM6IExpc3Qub2YobmV3IFRlcm0oXCJFeHByZXNzaW9uU3RhdGVtZW50XCIsIHtleHByZXNzaW9uOiBuZXcgVGVybShcIkZ1bmN0aW9uRXhwcmVzc2lvblwiLCB7aXNHZW5lcmF0b3I6IGZhbHNlLCBuYW1lOiBudWxsLCBwYXJhbXM6IG5ldyBUZXJtKFwiRm9ybWFsUGFyYW1ldGVyc1wiLCB7aXRlbXM6IHNhbmRib3hLZXlzXzM2NC5tYXAocGFyYW1fMzc3ID0+IHtcbiAgICByZXR1cm4gbmV3IFRlcm0oXCJCaW5kaW5nSWRlbnRpZmllclwiLCB7bmFtZTogU3ludGF4LmZyb20oXCJpZGVudGlmaWVyXCIsIHBhcmFtXzM3Nyl9KTtcbiAgfSksIHJlc3Q6IG51bGx9KSwgYm9keTogbmV3IFRlcm0oXCJGdW5jdGlvbkJvZHlcIiwge2RpcmVjdGl2ZXM6IExpc3Qub2YobmV3IFRlcm0oXCJEaXJlY3RpdmVcIiwge3Jhd1ZhbHVlOiBcInVzZSBzdHJpY3RcIn0pKSwgc3RhdGVtZW50czogTGlzdC5vZihuZXcgVGVybShcIlJldHVyblN0YXRlbWVudFwiLCB7ZXhwcmVzc2lvbjogZXhwcl8zNjB9KSl9KX0pfSkpfSkpO1xuICBsZXQgZ2VuXzM2NyA9IGNvZGVnZW4ocGFyc2VkXzM2NiwgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICBsZXQgcmVzdWx0XzM2OCA9IGNvbnRleHRfMzYxLnRyYW5zZm9ybShnZW5fMzY3LCB7YmFiZWxyYzogdHJ1ZSwgZmlsZW5hbWU6IGNvbnRleHRfMzYxLmZpbGVuYW1lfSk7XG4gIGxldCB2YWxfMzY5ID0gdm0ucnVuSW5Db250ZXh0KHJlc3VsdF8zNjguY29kZSwgY29udGV4dF8zNjEuc3RvcmUuZ2V0Tm9kZUNvbnRleHQoKSk7XG4gIHJldHVybiB2YWxfMzY5LmFwcGx5KHVuZGVmaW5lZCwgc2FuZGJveFZhbHNfMzY1KTtcbn1cbmV4cG9ydCB7c2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNDQgYXMgc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc307XG5leHBvcnQge2V2YWxSdW50aW1lVmFsdWVzXzM0NSBhcyBldmFsUnVudGltZVZhbHVlc307XG5leHBvcnQge2V2YWxDb21waWxldGltZVZhbHVlXzM0NiBhcyBldmFsQ29tcGlsZXRpbWVWYWx1ZX0iXX0=