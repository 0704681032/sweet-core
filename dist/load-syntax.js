"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.evalCompiletimeValue = exports.evalRuntimeValues = exports.sanitizeReplacementValues = undefined;

var _termExpander = require("./term-expander");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _immutable = require("immutable");

var _parseReducer = require("./parse-reducer.js");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _serializer = require("./serializer");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _transforms = require("./transforms");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _macroContext = require("./macro-context");

var _templateProcessor = require("./template-processor");

var _vm = require("vm");

var _vm2 = _interopRequireDefault(_vm);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let geval_364 = eval;
function sanitizeReplacementValues_365(values_368) {
  if (Array.isArray(values_368)) {
    return sanitizeReplacementValues_365((0, _immutable.List)(values_368));
  } else if (_immutable.List.isList(values_368)) {
    return values_368.map(sanitizeReplacementValues_365);
  } else if (values_368 == null) {
    throw new Error("replacement values for syntax template must not be null or undefined");
  } else if (typeof values_368.next === "function") {
    return sanitizeReplacementValues_365((0, _immutable.List)(values_368));
  }
  return (0, _macroContext.unwrap)(values_368);
}
function evalRuntimeValues_366(terms_369, context_370) {
  let prepped_371 = terms_369.reduce((acc_377, term_378) => {
    let result_379 = (0, _immutable.List)();
    if ((0, _terms.isExport)(term_378)) {
      if ((0, _terms.isVariableDeclaration)(term_378.declaration)) {
        return acc_377.concat(new _terms2.default("VariableDeclarationStatement", { declaration: term_378.declaration })).concat(term_378.declaration.declarators.map(decl_380 => {
          return new _terms2.default("ExpressionStatement", { expression: new _terms2.default("AssignmentExpression", { binding: new _terms2.default("StaticMemberExpression", { object: new _terms2.default("IdentifierExpression", { name: _syntax2.default.fromIdentifier("exports") }), property: decl_380.binding.name }), expression: new _terms2.default("IdentifierExpression", { name: decl_380.binding.name }) }) });
        }));
      }
    } else if ((0, _terms.isImport)(term_378)) {
      return acc_377;
    }
    return acc_377.concat(term_378);
  }, (0, _immutable.List)());
  let parsed_372 = (0, _shiftReducer2.default)(new _parseReducer2.default(context_370, false), new _terms2.default("Module", { directives: (0, _immutable.List)(), items: prepped_371 }).gen({ includeImports: false }));
  let gen_373 = (0, _shiftCodegen2.default)(parsed_372, new _shiftCodegen.FormattedCodeGen());
  let result_374 = context_370.transform(gen_373, { babelrc: true, filename: context_370.filename });
  let exportsObj_375 = {};
  context_370.store.set("exports", exportsObj_375);
  let val_376 = _vm2.default.runInContext(result_374.code, context_370.store.getNodeContext());
  return exportsObj_375;
}
function evalCompiletimeValue_367(expr_381, context_382) {
  let deserializer_383 = (0, _serializer.makeDeserializer)(context_382.bindings);
  let sandbox_384 = { syntaxQuote: function syntaxQuote(strings_392) {
      for (var _len = arguments.length, values_391 = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        values_391[_key - 1] = arguments[_key];
      }

      let ctx_393 = deserializer_383.read(_.last(values_391));
      let reader_394 = new _shiftReader2.default(strings_392, ctx_393, _.take(values_391.length - 1, values_391));
      return reader_394.read();
    }, syntaxTemplate: function syntaxTemplate(str_396) {
      for (var _len2 = arguments.length, values_395 = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        values_395[_key2 - 1] = arguments[_key2];
      }

      return (0, _templateProcessor.replaceTemplate)(deserializer_383.read(str_396), sanitizeReplacementValues_365(values_395));
    } };
  let sandboxKeys_385 = (0, _immutable.List)(Object.keys(sandbox_384));
  let sandboxVals_386 = sandboxKeys_385.map(k_397 => sandbox_384[k_397]).toArray();
  let parsed_387 = (0, _shiftReducer2.default)(new _parseReducer2.default(context_382), new _terms2.default("Module", { directives: (0, _immutable.List)(), items: _immutable.List.of(new _terms2.default("ExpressionStatement", { expression: new _terms2.default("FunctionExpression", { isGenerator: false, name: null, params: new _terms2.default("FormalParameters", { items: sandboxKeys_385.map(param_398 => {
            return new _terms2.default("BindingIdentifier", { name: _syntax2.default.from("identifier", param_398) });
          }), rest: null }), body: new _terms2.default("FunctionBody", { directives: _immutable.List.of(new _terms2.default("Directive", { rawValue: "use strict" })), statements: _immutable.List.of(new _terms2.default("ReturnStatement", { expression: expr_381 })) }) }) })) }));
  let gen_388 = (0, _shiftCodegen2.default)(parsed_387, new _shiftCodegen.FormattedCodeGen());
  let result_389 = context_382.transform(gen_388, { babelrc: true, filename: context_382.filename });
  let val_390 = _vm2.default.runInContext(result_389.code, context_382.store.getNodeContext());
  return val_390.apply(undefined, sandboxVals_386);
}
exports.sanitizeReplacementValues = sanitizeReplacementValues_365;
exports.evalRuntimeValues = evalRuntimeValues_366;
exports.evalCompiletimeValue = evalCompiletimeValue_367;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L2xvYWQtc3ludGF4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0lBQWEsQzs7Ozs7O0FBQ2IsSUFBSSxZQUFZLElBQWhCO0FBQ0EsU0FBUyw2QkFBVCxDQUF1QyxVQUF2QyxFQUFtRDtBQUNqRCxNQUFJLE1BQU0sT0FBTixDQUFjLFVBQWQsQ0FBSixFQUErQjtBQUM3QixXQUFPLDhCQUE4QixxQkFBSyxVQUFMLENBQTlCLENBQVA7QUFDRCxHQUZELE1BRU8sSUFBSSxnQkFBSyxNQUFMLENBQVksVUFBWixDQUFKLEVBQTZCO0FBQ2xDLFdBQU8sV0FBVyxHQUFYLENBQWUsNkJBQWYsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJLGNBQWMsSUFBbEIsRUFBd0I7QUFDN0IsVUFBTSxJQUFJLEtBQUosQ0FBVSxzRUFBVixDQUFOO0FBQ0QsR0FGTSxNQUVBLElBQUksT0FBTyxXQUFXLElBQWxCLEtBQTJCLFVBQS9CLEVBQTJDO0FBQ2hELFdBQU8sOEJBQThCLHFCQUFLLFVBQUwsQ0FBOUIsQ0FBUDtBQUNEO0FBQ0QsU0FBTywwQkFBTyxVQUFQLENBQVA7QUFDRDtBQUNELFNBQVMscUJBQVQsQ0FBK0IsU0FBL0IsRUFBMEMsV0FBMUMsRUFBdUQ7QUFDckQsTUFBSSxjQUFjLFVBQVUsTUFBVixDQUFpQixDQUFDLE9BQUQsRUFBVSxRQUFWLEtBQXVCO0FBQ3hELFFBQUksYUFBYSxzQkFBakI7QUFDQSxRQUFJLHFCQUFTLFFBQVQsQ0FBSixFQUF3QjtBQUN0QixVQUFJLGtDQUFzQixTQUFTLFdBQS9CLENBQUosRUFBaUQ7QUFDL0MsZUFBTyxRQUFRLE1BQVIsQ0FBZSxvQkFBUyw4QkFBVCxFQUF5QyxFQUFDLGFBQWEsU0FBUyxXQUF2QixFQUF6QyxDQUFmLEVB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QixFQUFDLGFBQWEsS0FBZCxFQUFxQixNQUFNLElBQTNCLEVBQWlDLFFBQVEsb0JBQVMsa0JBQVQsRUFBNkIsRUFBQyxPQUFPLGdCQUFnQixHQUFoQixDQUFvQixhQUFhO0FBQ3hTLG1CQUFPLG9CQUFTLG1CQUFULEVBQThCLEVBQUMsTUFBTSxpQkFBTyxJQUFQLENBQVksWUFBWixFQUEwQixTQUExQixDQUFQLEVBQTlCLENBQVA7QUFDRCxXQUZ3USxDQUFSLEVBRTdQLE1BQU0sSUFGdVAsRUFBN0IsQ0FBekMsRUFFekssTUFBTSxvQkFBUyxjQUFULEVBQXlCLEVBQUMsWUFBWSxnQkFBSyxFQUFMLENBQVEsb0JBQVMsV0FBVCxFQUFzQixFQUFDLFVBQVUsWUFBWCxFQUF0QixDQUFSLENBQWIsRUFBdUUsWUFBWSxnQkFBSyxFQUFMLENBQVEsb0JBQVMsaUJBQVQsRUFBNEIsRUFBQyxZQUFZLFFBQWIsRUFBNUIsQ0FBUixDQUFuRixFQUF6QixDQUZtSyxFQUEvQixDQUFiLEVBQWhDLENBQVIsQ0FBNUIsRUFBbkIsQ0FBdkMsQ0FBakI7QUFHQSxNQUFJLFVBQVUsNEJBQVEsVUFBUixFQUFvQixvQ0FBcEIsQ0FBZDtBQUNBLE1BQUksYUFBYSxZQUFZLFNBQVosQ0FBc0IsT0FBdEIsRUFBK0IsRUFBQyxTQUFTLElBQVYsRUFBZ0IsVUFBVSxZQUFZLFFBQXRDLEVBQS9CLENBQWpCO0FBQ0EsTUFBSSxVQUFVLGFBQUcsWUFBSCxDQUFnQixXQUFXLElBQTNCLEVBQWlDLFlBQVksS0FBWixDQUFrQixjQUFsQixFQUFqQyxDQUFkO0FBQ0EsU0FBTyxRQUFRLEtBQVIsQ0FBYyxTQUFkLEVBQXlCLGVBQXpCLENBQVA7QUFDRDtRQUN3Qyx5QixHQUFqQyw2QjtRQUN5QixpQixHQUF6QixxQjtRQUM0QixvQixHQUE1Qix3QiIsImZpbGUiOiJsb2FkLXN5bnRheC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlclwiO1xuaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgUGFyc2VSZWR1Y2VyIGZyb20gXCIuL3BhcnNlLXJlZHVjZXIuanNcIjtcbmltcG9ydCByZWR1Y2VyLCB7TW9ub2lkYWxSZWR1Y2VyfSBmcm9tIFwic2hpZnQtcmVkdWNlclwiO1xuaW1wb3J0IHttYWtlRGVzZXJpYWxpemVyfSBmcm9tIFwiLi9zZXJpYWxpemVyXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGNvZGVnZW4sIHtGb3JtYXR0ZWRDb2RlR2VufSBmcm9tIFwic2hpZnQtY29kZWdlblwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IFRlcm0sIHtpc0VPRiwgaXNCaW5kaW5nSWRlbnRpZmllciwgaXNGdW5jdGlvbkRlY2xhcmF0aW9uLCBpc0Z1bmN0aW9uRXhwcmVzc2lvbiwgaXNGdW5jdGlvblRlcm0sIGlzRnVuY3Rpb25XaXRoTmFtZSwgaXNTeW50YXhEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uLCBpc1ZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnQsIGlzSW1wb3J0LCBpc0V4cG9ydH0gZnJvbSBcIi4vdGVybXNcIjtcbmltcG9ydCBSZWFkZXIgZnJvbSBcIi4vc2hpZnQtcmVhZGVyXCI7XG5pbXBvcnQge3Vud3JhcH0gZnJvbSBcIi4vbWFjcm8tY29udGV4dFwiO1xuaW1wb3J0IHtyZXBsYWNlVGVtcGxhdGV9IGZyb20gXCIuL3RlbXBsYXRlLXByb2Nlc3NvclwiO1xuaW1wb3J0IHZtIGZyb20gXCJ2bVwiO1xuaW1wb3J0ICAqIGFzIF8gZnJvbSBcInJhbWRhXCI7XG5sZXQgZ2V2YWxfMzY0ID0gZXZhbDtcbmZ1bmN0aW9uIHNhbml0aXplUmVwbGFjZW1lbnRWYWx1ZXNfMzY1KHZhbHVlc18zNjgpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzXzM2OCkpIHtcbiAgICByZXR1cm4gc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNjUoTGlzdCh2YWx1ZXNfMzY4KSk7XG4gIH0gZWxzZSBpZiAoTGlzdC5pc0xpc3QodmFsdWVzXzM2OCkpIHtcbiAgICByZXR1cm4gdmFsdWVzXzM2OC5tYXAoc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNjUpO1xuICB9IGVsc2UgaWYgKHZhbHVlc18zNjggPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInJlcGxhY2VtZW50IHZhbHVlcyBmb3Igc3ludGF4IHRlbXBsYXRlIG11c3Qgbm90IGJlIG51bGwgb3IgdW5kZWZpbmVkXCIpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZXNfMzY4Lm5leHQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHJldHVybiBzYW5pdGl6ZVJlcGxhY2VtZW50VmFsdWVzXzM2NShMaXN0KHZhbHVlc18zNjgpKTtcbiAgfVxuICByZXR1cm4gdW53cmFwKHZhbHVlc18zNjgpO1xufVxuZnVuY3Rpb24gZXZhbFJ1bnRpbWVWYWx1ZXNfMzY2KHRlcm1zXzM2OSwgY29udGV4dF8zNzApIHtcbiAgbGV0IHByZXBwZWRfMzcxID0gdGVybXNfMzY5LnJlZHVjZSgoYWNjXzM3NywgdGVybV8zNzgpID0+IHtcbiAgICBsZXQgcmVzdWx0XzM3OSA9IExpc3QoKTtcbiAgICBpZiAoaXNFeHBvcnQodGVybV8zNzgpKSB7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fMzc4LmRlY2xhcmF0aW9uKSkge1xuICAgICAgICByZXR1cm4gYWNjXzM3Ny5jb25jYXQobmV3IFRlcm0oXCJWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50XCIsIHtkZWNsYXJhdGlvbjogdGVybV8zNzguZGVjbGFyYXRpb259KSkuY29uY2F0KHRlcm1fMzc4LmRlY2xhcmF0aW9uLmRlY2xhcmF0b3JzLm1hcChkZWNsXzM4MCA9PiB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwcmVzc2lvblN0YXRlbWVudFwiLCB7ZXhwcmVzc2lvbjogbmV3IFRlcm0oXCJBc3NpZ25tZW50RXhwcmVzc2lvblwiLCB7YmluZGluZzogbmV3IFRlcm0oXCJTdGF0aWNNZW1iZXJFeHByZXNzaW9uXCIsIHtvYmplY3Q6IG5ldyBUZXJtKFwiSWRlbnRpZmllckV4cHJlc3Npb25cIiwge25hbWU6IFN5bnRheC5mcm9tSWRlbnRpZmllcihcImV4cG9ydHNcIil9KSwgcHJvcGVydHk6IGRlY2xfMzgwLmJpbmRpbmcubmFtZX0pLCBleHByZXNzaW9uOiBuZXcgVGVybShcIklkZW50aWZpZXJFeHByZXNzaW9uXCIsIHtuYW1lOiBkZWNsXzM4MC5iaW5kaW5nLm5hbWV9KX0pfSk7XG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzSW1wb3J0KHRlcm1fMzc4KSkge1xuICAgICAgcmV0dXJuIGFjY18zNzc7XG4gICAgfVxuICAgIHJldHVybiBhY2NfMzc3LmNvbmNhdCh0ZXJtXzM3OCk7XG4gIH0sIExpc3QoKSk7XG4gIGxldCBwYXJzZWRfMzcyID0gcmVkdWNlcihuZXcgUGFyc2VSZWR1Y2VyKGNvbnRleHRfMzcwLCBmYWxzZSksIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBwcmVwcGVkXzM3MX0pLmdlbih7aW5jbHVkZUltcG9ydHM6IGZhbHNlfSkpO1xuICBsZXQgZ2VuXzM3MyA9IGNvZGVnZW4ocGFyc2VkXzM3MiwgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICBsZXQgcmVzdWx0XzM3NCA9IGNvbnRleHRfMzcwLnRyYW5zZm9ybShnZW5fMzczLCB7YmFiZWxyYzogdHJ1ZSwgZmlsZW5hbWU6IGNvbnRleHRfMzcwLmZpbGVuYW1lfSk7XG4gIGxldCBleHBvcnRzT2JqXzM3NSA9IHt9O1xuICBjb250ZXh0XzM3MC5zdG9yZS5zZXQoXCJleHBvcnRzXCIsIGV4cG9ydHNPYmpfMzc1KTtcbiAgbGV0IHZhbF8zNzYgPSB2bS5ydW5JbkNvbnRleHQocmVzdWx0XzM3NC5jb2RlLCBjb250ZXh0XzM3MC5zdG9yZS5nZXROb2RlQ29udGV4dCgpKTtcbiAgcmV0dXJuIGV4cG9ydHNPYmpfMzc1O1xufVxuZnVuY3Rpb24gZXZhbENvbXBpbGV0aW1lVmFsdWVfMzY3KGV4cHJfMzgxLCBjb250ZXh0XzM4Mikge1xuICBsZXQgZGVzZXJpYWxpemVyXzM4MyA9IG1ha2VEZXNlcmlhbGl6ZXIoY29udGV4dF8zODIuYmluZGluZ3MpO1xuICBsZXQgc2FuZGJveF8zODQgPSB7c3ludGF4UXVvdGU6IGZ1bmN0aW9uIChzdHJpbmdzXzM5MiwgLi4udmFsdWVzXzM5MSkge1xuICAgIGxldCBjdHhfMzkzID0gZGVzZXJpYWxpemVyXzM4My5yZWFkKF8ubGFzdCh2YWx1ZXNfMzkxKSk7XG4gICAgbGV0IHJlYWRlcl8zOTQgPSBuZXcgUmVhZGVyKHN0cmluZ3NfMzkyLCBjdHhfMzkzLCBfLnRha2UodmFsdWVzXzM5MS5sZW5ndGggLSAxLCB2YWx1ZXNfMzkxKSk7XG4gICAgcmV0dXJuIHJlYWRlcl8zOTQucmVhZCgpO1xuICB9LCBzeW50YXhUZW1wbGF0ZTogZnVuY3Rpb24gKHN0cl8zOTYsIC4uLnZhbHVlc18zOTUpIHtcbiAgICByZXR1cm4gcmVwbGFjZVRlbXBsYXRlKGRlc2VyaWFsaXplcl8zODMucmVhZChzdHJfMzk2KSwgc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNjUodmFsdWVzXzM5NSkpO1xuICB9fTtcbiAgbGV0IHNhbmRib3hLZXlzXzM4NSA9IExpc3QoT2JqZWN0LmtleXMoc2FuZGJveF8zODQpKTtcbiAgbGV0IHNhbmRib3hWYWxzXzM4NiA9IHNhbmRib3hLZXlzXzM4NS5tYXAoa18zOTcgPT4gc2FuZGJveF8zODRba18zOTddKS50b0FycmF5KCk7XG4gIGxldCBwYXJzZWRfMzg3ID0gcmVkdWNlcihuZXcgUGFyc2VSZWR1Y2VyKGNvbnRleHRfMzgyKSwgbmV3IFRlcm0oXCJNb2R1bGVcIiwge2RpcmVjdGl2ZXM6IExpc3QoKSwgaXRlbXM6IExpc3Qub2YobmV3IFRlcm0oXCJFeHByZXNzaW9uU3RhdGVtZW50XCIsIHtleHByZXNzaW9uOiBuZXcgVGVybShcIkZ1bmN0aW9uRXhwcmVzc2lvblwiLCB7aXNHZW5lcmF0b3I6IGZhbHNlLCBuYW1lOiBudWxsLCBwYXJhbXM6IG5ldyBUZXJtKFwiRm9ybWFsUGFyYW1ldGVyc1wiLCB7aXRlbXM6IHNhbmRib3hLZXlzXzM4NS5tYXAocGFyYW1fMzk4ID0+IHtcbiAgICByZXR1cm4gbmV3IFRlcm0oXCJCaW5kaW5nSWRlbnRpZmllclwiLCB7bmFtZTogU3ludGF4LmZyb20oXCJpZGVudGlmaWVyXCIsIHBhcmFtXzM5OCl9KTtcbiAgfSksIHJlc3Q6IG51bGx9KSwgYm9keTogbmV3IFRlcm0oXCJGdW5jdGlvbkJvZHlcIiwge2RpcmVjdGl2ZXM6IExpc3Qub2YobmV3IFRlcm0oXCJEaXJlY3RpdmVcIiwge3Jhd1ZhbHVlOiBcInVzZSBzdHJpY3RcIn0pKSwgc3RhdGVtZW50czogTGlzdC5vZihuZXcgVGVybShcIlJldHVyblN0YXRlbWVudFwiLCB7ZXhwcmVzc2lvbjogZXhwcl8zODF9KSl9KX0pfSkpfSkpO1xuICBsZXQgZ2VuXzM4OCA9IGNvZGVnZW4ocGFyc2VkXzM4NywgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICBsZXQgcmVzdWx0XzM4OSA9IGNvbnRleHRfMzgyLnRyYW5zZm9ybShnZW5fMzg4LCB7YmFiZWxyYzogdHJ1ZSwgZmlsZW5hbWU6IGNvbnRleHRfMzgyLmZpbGVuYW1lfSk7XG4gIGxldCB2YWxfMzkwID0gdm0ucnVuSW5Db250ZXh0KHJlc3VsdF8zODkuY29kZSwgY29udGV4dF8zODIuc3RvcmUuZ2V0Tm9kZUNvbnRleHQoKSk7XG4gIHJldHVybiB2YWxfMzkwLmFwcGx5KHVuZGVmaW5lZCwgc2FuZGJveFZhbHNfMzg2KTtcbn1cbmV4cG9ydCB7c2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc18zNjUgYXMgc2FuaXRpemVSZXBsYWNlbWVudFZhbHVlc307XG5leHBvcnQge2V2YWxSdW50aW1lVmFsdWVzXzM2NiBhcyBldmFsUnVudGltZVZhbHVlc307XG5leHBvcnQge2V2YWxDb21waWxldGltZVZhbHVlXzM2NyBhcyBldmFsQ29tcGlsZXRpbWVWYWx1ZX0iXX0=